<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial 08: Floating point computations and least squares (solutions) • StatCompLab</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial 08: Floating point computations and least squares (solutions)">
<meta property="og:description" content="Statistical Computing: Lab tutorial 8">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">StatCompLab</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.8.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Lab01.html">Lab01</a>
    </li>
    <li>
      <a href="../articles/Lab02.html">Lab02</a>
    </li>
    <li>
      <a href="../articles/Lab03.html">Lab03</a>
    </li>
    <li>
      <a href="../articles/Project01.html">StatComp Project 1 (2020/21): Numerical statistics</a>
    </li>
    <li>
      <a href="../articles/Project01Hints.html">Project 01 Hints</a>
    </li>
    <li>
      <a href="../articles/Tutorial01.html">Tutorial 01: R and linear models</a>
    </li>
    <li>
      <a href="../articles/Tutorial01Solutions.html">Tutorial 01: R and linear models (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial03.html">Tutorial 03: Monte Carlo integration</a>
    </li>
    <li>
      <a href="../articles/Tutorial03Solutions.html">Tutorial 03: Monte Carlo integration (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial04.html">Tutorial 04: Uncertainty and integration</a>
    </li>
    <li>
      <a href="../articles/Tutorial04Solutions.html">Tutorial 04: Uncertainty and integration (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial06.html">Tutorial 06: Prediction assessment with proper scores</a>
    </li>
    <li>
      <a href="../articles/Tutorial06Solutions.html">Tutorial 06: Prediction assessment with proper scores (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial07.html">Tutorial 07: Data wrangling and cross validation</a>
    </li>
    <li>
      <a href="../articles/Tutorial07Solutions.html">Tutorial 07: Data wrangling and cross validation (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial08.html">Tutorial 08: Floating point computations and least squares</a>
    </li>
    <li>
      <a href="../articles/Tutorial08Solutions.html">Tutorial 08: Floating point computations and least squares (solutions)</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/finnlindgren/StatCompLab/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Tutorial08Solutions_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tutorial 08: Floating point computations and least squares (solutions)</h1>
                        <h4 class="author">Finn Lindgren</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/finnlindgren/StatCompLab/blob/master/vignettes/Tutorial08Solutions.Rmd"><code>vignettes/Tutorial08Solutions.Rmd</code></a></small>
      <div class="hidden name"><code>Tutorial08Solutions.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>In this lab session you will explore</p>
<ul>
<li>Speed of matrix computations</li>
<li>Floating point accuracy in least squares estimation of statistical linear models</li>
</ul>
<ol style="list-style-type: decimal">
<li>Open your github repository clone project from Lab 2 (either on <a href="https://rstudio.cloud">https://rstudio.cloud</a> or on your own computer and upgrade the <code>StatCompLab</code> package (see the <code>Lab03</code> vignette for more details)</li>
<li>During this lab, you can work in a <code>.R</code> file, but working with code chunks in a <code>.Rmd</code> is highly recommended.</li>
<li>Make sure you update the <code>StatCompLab</code> package to version 0.8.2 or higher.</li>
</ol>
<p>For measuring relative running times of different methods, we’ll use the <code>bench</code> package. You won’t need to load the package with <code>library</code>. Instead, check if <code><a href="https://rdrr.io/pkg/bench/man/mark.html">bench::mark()</a></code> runs without errors. If it doesn’t, and it’s because the package is not installed, then install it with <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("bench")</a></code> in the R Console.</p>
<p>Suggested code for the setup code chunk:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://finnlindgren.github.io/StatCompLab">StatCompLab</a></span><span class="op">)</span></code></pre></div>
<!--

The accompanying `Tutorial08Solutions` tutorial/vignette documents contain the
solutions explicitly, to make it easier to review the material after the workshops.
-->
</div>
<div id="numerical-speed" class="section level2">
<h2 class="hasAnchor">
<a href="#numerical-speed" class="anchor"></a>Numerical speed</h2>
<p>Define the following function for computing a vector norm:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vec_norm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">0.5</span>
<span class="op">}</span></code></pre></div>
<p>Try it on a simple vector where you can verify that the result is correct, e.g.<br></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">vec_norm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">4</span> <span class="op">+</span> <span class="fl">9</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 3.741657 3.741657</code></pre>
<p>We will now take a look at the computational speed of matrix operations.</p>
<p>First construct a vector <span class="math inline">\(\boldsymbol{b}\)</span> and matrix <span class="math inline">\(\boldsymbol{A}\)</span>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100000</span>
<span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">m</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">m</span><span class="op">)</span></code></pre></div>
<p>Let’s check the speed difference between <span class="math inline">\(\boldsymbol{A}^\top\boldsymbol{b}\)</span> and <span class="math inline">\((\boldsymbol{b}^\top\boldsymbol{A})^\top\)</span> (convince yourself that the two expressions would be equivalent in exact arithmetic, and possibly also in floating point arithmetic). The function <code><a href="https://rdrr.io/r/base/t.html">t()</a></code> construct the transpose of a matrix. Note that when <code>b</code> is a vector (as opposed to a single-column matrix) it is interpreted as either a column vector or a row vector, depending on the operation. When <code>b</code> is a vector, <code><a href="https://rdrr.io/r/base/matrix.html">as.matrix(b)</a></code> is always a single-column matrix, and <code><a href="https://rdrr.io/r/base/t.html">t(b)</a></code> is a single-row matrix, but <code>b %*% A</code> is interpreted as <code>t(b) %*% A</code>.</p>
<p>Which method for computing <span class="math inline">\(\boldsymbol{A}^\top \boldsymbol{b}\)</span> is faster? Use <code><a href="https://rdrr.io/pkg/bench/man/mark.html">bench::mark()</a></code> to compare the different ways of evaluating the expression. By extracting the variables <code>expression</code>, <code>median</code>, and <code>itr/sec</code> from the <code><a href="https://rdrr.io/pkg/bench/man/mark.html">bench::mark()</a></code> output using the <code>select()</code> function, we can summarise the results in a table.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">b</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">A</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">b</span> <span class="op">%*%</span> <span class="va">A</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">bm</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">expression</span>, <span class="va">median</span>, <span class="va">`itr/sec`</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">t(A) %*% b</td>
<td align="right">79.6ms</td>
<td align="right">12.58946</td>
</tr>
<tr class="even">
<td align="left">t(t(b) %*% A)</td>
<td align="right">22.3ms</td>
<td align="right">44.11257</td>
</tr>
<tr class="odd">
<td align="left">t(b %*% A)</td>
<td align="right">22.3ms</td>
<td align="right">44.30371</td>
</tr>
</tbody>
</table>
<hr>
<p>To save typing, define a function <code>bench_table</code> that does the <code>kable</code> printing:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bench_table</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bm</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>
    <span class="va">bm</span> <span class="op">%&gt;%</span>
      <span class="fu">select</span><span class="op">(</span><span class="va">expression</span>, <span class="va">median</span>, <span class="va">`itr/sec`</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<hr>
<p><strong>Solution:</strong></p>
<p>The <code>t(A) %*% b</code> method is the slowest implementation. Transposing a matrix requires copying the values to new locations. Transposing a vector doesn’t require any copying.</p>
<hr>
<p>For <span class="math inline">\(\boldsymbol{A}\boldsymbol{B}\boldsymbol{b}\)</span>, the order in which matrix&amp;vector multiplication is done is important. Define these new variables:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, <span class="va">m</span>, <span class="va">n</span><span class="op">)</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></code></pre></div>
<p>Compare the running times of <code>A %*% B %*% b</code>, <code>(A %*% B) %*% b</code>, and <code>A %*% (B %*% b))</code>.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="va">A</span> <span class="op">%*%</span> <span class="va">B</span> <span class="op">%*%</span> <span class="va">b</span>,
  <span class="op">(</span><span class="va">A</span> <span class="op">%*%</span> <span class="va">B</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">b</span>,
  <span class="va">A</span> <span class="op">%*%</span> <span class="op">(</span><span class="va">B</span> <span class="op">%*%</span> <span class="va">b</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">bench_table</span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">A %<em>% B %</em>% b</td>
<td align="right">778.23ms</td>
<td align="right">1.284974</td>
</tr>
<tr class="even">
<td align="left">(A %<em>% B) %</em>% b</td>
<td align="right">801.22ms</td>
<td align="right">1.248093</td>
</tr>
<tr class="odd">
<td align="left">A %<em>% (B %</em>% b)</td>
<td align="right">2.37ms</td>
<td align="right">414.584280</td>
</tr>
</tbody>
</table>
<hr>
<p>The three versions should produce very similar numerical results (<code><a href="https://rdrr.io/pkg/bench/man/mark.html">bench::mark</a></code> will complain if they don’t) Which method is fastest? Why? Are the computed results the same?</p>
<hr>
<p><strong>Solution:</strong></p>
<p>One matrix-matrix multiplication is very expensive compared with matrix-vector multiplication. The results are numerically very close, and one can likely express bounds for them in terms of <code>.Machine$double.eps</code> and <span class="math inline">\(m,n,p\)</span>.</p>
<hr>
<p>For a square matrix <span class="math inline">\(\boldsymbol{A}\)</span> of size <span class="math inline">\(1000\times 1000\)</span>, compare the cost of <code>solve(A) %*% b</code> (Get the matrix inverse <span class="math inline">\(\boldsymbol{A}^{-1}\)</span>, then multiply with <span class="math inline">\(\boldsymbol{b}\)</span>) against the cost of <code><a href="https://rdrr.io/r/base/solve.html">solve(A, b)</a></code> (Solve the linear system <span class="math inline">\(\boldsymbol{A}\boldsymbol{u}=\boldsymbol{b}\)</span>).</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">b</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">b</span><span class="op">)</span>,
  check <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># The results will differ by approximately 8e-13</span>
<span class="op">)</span>
<span class="fu">bench_table</span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">solve(A) %*% b</td>
<td align="right">926ms</td>
<td align="right">1.079715</td>
</tr>
<tr class="even">
<td align="left">solve(A, b)</td>
<td align="right">288ms</td>
<td align="right">3.477726</td>
</tr>
</tbody>
</table>
<hr>
</div>
<div id="numerical-least-squares-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#numerical-least-squares-estimation" class="anchor"></a>Numerical Least Squares estimation</h2>
<p>You’ll now investigate some numerical issues when doing numerical least squares estimation.</p>
<p>Run the following code that generates synthetic observations from a linear model <span class="math display">\[
\begin{aligned}
y_i &amp;= \frac{x_i-100.5}{5} + (x_i-100.5)^2 + e_i,
\end{aligned}
\]</span> where <span class="math inline">\(e_i \sim \mathsf{Normal}(0, \sigma_e=0.1)\)</span>, independent, <span class="math inline">\(i=1,\dots,n=100\)</span>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Set the "seed" for the random number sequences, so we can</span>
<span class="co">## reproduce exactly the same random numbers every time we run the code</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="co">## Simulate the data</span>
<span class="co"># x: 100 random numbers between 100 and 101</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># y: random variation around a quadratic function:</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">100.5</span><span class="op">)</span> <span class="op">/</span> <span class="fl">5</span> <span class="op">+</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">100.5</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let’s plot the data we have stored in the <code>data.frame</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial08Solutions_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
<p>What are the true values of <span class="math inline">\(\beta_0\)</span>, <span class="math inline">\(\beta_1\)</span>, and <span class="math inline">\(\beta_2\)</span> in the standardised model formulation, <span class="math display">\[
\begin{aligned}
y_i &amp;= \mu_i + e_i = \beta_0 + \beta_1 x_i + \beta_2 x_i^2 + e_i ?
\end{aligned}
\]</span> Hint: Identify the values by matching the terms when expanding the initial model definition above.</p>
<hr>
<p><strong>Solution:</strong></p>
<p><span class="math display">\[
\begin{aligned}
\beta_0 &amp;= -\frac{100.5}{5} + 100.5^2 = 10080.15 \\
\beta_1 &amp;= \frac{1}{5} - 201 = -200.8 \\
\beta_2 &amp;= 1
\end{aligned}
\]</span></p>
<hr>
<p>Create a <code>beta_true</code> vector containing <span class="math inline">\((\beta_0, \beta_1, \beta_2)\)</span>:</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">beta_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10080.15</span>, <span class="op">-</span><span class="fl">200.8</span>, <span class="fl">1</span><span class="op">)</span>
<span class="co"># beta_0 = -100.5/5 + 100.5^2 = 10080.15</span>
<span class="co"># beta_1 = 1/5 - 201 = -200.8</span>
<span class="co"># beta_2 = 1</span></code></pre></div>
<hr>
<p>Use these <span class="math inline">\(\beta\)</span>-values to plot the quadratic true model predictor function as a function of <span class="math inline">\(x\in[100,101]\)</span>, together with the observations, and the estimate provided by <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>. Since the observed <span class="math inline">\(x\)</span> values are relatively dense, we don’t necessarily need a special plot sequence of <span class="math inline">\(x\)</span> values, but can reuse the observed values, and the model predictions for those value can be obtained with the <code><a href="https://rdrr.io/r/stats/fitted.values.html">fitted()</a></code> method. In the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> formula specification, use <code>+ I(x^2)</code> for the quadratic term. This tells <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> to first compute <code>x^2</code>, and then use the result as a new covariate. The <code><a href="https://rdrr.io/r/base/AsIs.html">I()</a></code> method can be interpreted as “use the computed value of this instead of other possible special meanings of the expression”.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>mu_true <span class="op">=</span> <span class="va">beta_true</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta_true</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="va">beta_true</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
<span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mu_true</span>, col <span class="op">=</span><span class="st">"True"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## lm manages to estimate the regression:</span>
<span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="co">## Add the fitted curve:</span>
<span class="va">pl</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"Estimated"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial08Solutions_files/figure-html/unnamed-chunk-13-1.png" width="576"></p>
<hr>
<p>Use the <code><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix(mod1)</a></code> function to extract the <span class="math inline">\(\boldsymbol{X}\)</span> matrix for the vector formulation of the model, <span class="math inline">\(\boldsymbol{y}=\boldsymbol{X}\boldsymbol{\beta}+\boldsymbol{e}\)</span>, and store in <code>X1</code>. (See <code><a href="https://rdrr.io/r/stats/model.matrix.html">?model.matrix</a></code> for more information). Then use the direct <em>normal equations</em> solve shown in Lecture 8, <span class="math inline">\((\boldsymbol{X}^\top\boldsymbol{X})^{-1}\boldsymbol{X}^\top\boldsymbol{y}\)</span>, to estimate the <span class="math inline">\(\beta\)</span> parameters. Does it work?</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span>
<span class="co"># To allow the tutorial document to keep running even in case of errors, wrap in try()</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span>
  <span class="va">beta.hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">X1</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Error in solve.default(t(X1) %*% X1, t(X1) %*% data$y) : 
##   system is computationally singular: reciprocal condition number = 3.9864e-19</code></pre>
<hr>
</div>
<div id="shifted-covariate" class="section level2">
<h2 class="hasAnchor">
<a href="#shifted-covariate" class="anchor"></a>Shifted covariate</h2>
<p>What if the whole model was shifted to the right, so that we were given <span class="math inline">\(x+1000\)</span> instead of the original <span class="math inline">\(x\)</span>-values? The model expression would still be able to represent the same quadratic expression but with different <span class="math inline">\(\beta\)</span> values. Create a new data set:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data2</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1000</span><span class="op">)</span></code></pre></div>
<p>Estimate the model using <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> for this new data set. Does it work?</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data2</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"mod1"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"mod2"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial08Solutions_files/figure-html/unnamed-chunk-16-1.png" width="576"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># lm() fails to fit the correct curve, without warning!</span></code></pre></div>
<p><code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> fails to fit the correct curve, without warning!</p>
<hr>
<p>The default for <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> is to allow singular models, and “fix” the problem by removing co-linear columns of the model matrix. We can ask it to disallow singular models with the <code>singular.ok</code> argument.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span>
  <span class="va">mod2b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data2</span>, singular.ok <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Error in lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) : 
##   singular fit encountered</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Now lm refuses to compute an estimate.</span></code></pre></div>
<hr>
<p>Define a function <code>cond_nr()</code> taking a matrix <code>X</code> as input and returning the condition number, computed with the help of <code>svd</code> (see Lecture 8 for a code example for the condition number).</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cond_nr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">$</span><span class="va">d</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<hr>
<p>With the help of <code>model.matrix</code>, examine the condition numbers of the model matrices in the two cases from the previous tasks. <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> computes the fit using the QR decomposition approach, not by direct solution of the normal equations. Why was the second <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> fit so bad?</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">cond_nr</span><span class="op">(</span><span class="va">X1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1560769713</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># large, but somewhat manageable condition number</span>

<span class="va">X2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span>
<span class="fu">cond_nr</span><span class="op">(</span><span class="va">X2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2.242481e+13</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># very large condition number,</span>
<span class="co"># but not large enough to trigger a warning!</span></code></pre></div>
<hr>
<p>Plot the second and third columns of the model matrix <code>X2</code> against each other, and use <code>cor</code> to examine their correlation (see <code><a href="https://rdrr.io/r/stats/cor.html">?cor</a></code>). How does this explain the large condition number?</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##        x I(x^2)
## x      1      1
## I(x^2) 1      1</code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">X2</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Correlation ="</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">X2</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial08Solutions_files/figure-html/unnamed-chunk-20-1.png" width="576"></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Very close to co-linear</span></code></pre></div>
<hr>
<p><strong>Solution:</strong></p>
<p>In both cases the columns are virtually co-linear, which leads to a very small <span class="math inline">\(d_3\)</span> value, and therefore a large condition number.</p>
<hr>
<p>Since the linear model says simply that the expected value vector <span class="math inline">\(\mathsf{E}(\boldsymbol{y})\)</span> lies in the space spanned by the columns of <span class="math inline">\(\boldsymbol{X}\)</span>, one possibility is to attempt to arrive at a better conditioned <span class="math inline">\(\boldsymbol{X}\)</span> by linear rescaling and/or recombination of its columns. This is always equivalent to a linear re-parameterization.</p>
<p>Try this on the model matrix of the model that causes <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> to fail. In particular, for each column (except the intercept column) subtract the column mean (e.g., try the <code><a href="https://rdrr.io/r/base/sweep.html">sweep()</a></code> and <code><a href="https://rdrr.io/r/base/colSums.html">colMeans()</a></code> functions, see example code below). Then divide each column (except the intercept column) by its standard deviation. Find the condition number of the new model matrix. Fit the model with this model matrix using something like <code>mod3 &lt;- lm(y ~ x1 + x2 + x3 - 1, data = data3)</code></p>
<p>Produce a plot that confirms that the resulting fit is sensible now.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Solution code:</span>
<span class="va">mean_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>
<span class="va">sd_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">X3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>
  <span class="va">X2</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">mean_vec</span>, FUN <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">X3</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span><span class="op">(</span><span class="va">X3</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">sd_vec</span>, FUN <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>
<span class="va">data3</span> <span class="op">&lt;-</span> <span class="va">data2</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>x1 <span class="op">=</span> <span class="va">X3</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, x2 <span class="op">=</span> <span class="va">X3</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, x3 <span class="op">=</span> <span class="va">X3</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span>

<span class="va">mod3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">data3</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">mod3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial08Solutions_files/figure-html/unnamed-chunk-21-1.png" width="576"></p>
<hr>
<p>Note: If the data is split into estimation and test sets, the same transformation must be applied to the test data, using the scaling parameters derived from the observation data. Therefore the <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> function isn’t very useful for this. Instead, explicitly computing and storing the transformation information is necessary.</p>
<p>Compute the condition numbers for <code>X2</code> and <code>X3</code>. Also compute the correlation between column 2 and 3 of <code>X3</code> (subtract <span class="math inline">\(1\)</span> to see how close to <span class="math inline">\(1\)</span> it is).</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">cond_nr</span><span class="op">(</span><span class="va">X2</span><span class="op">)</span>, <span class="fu">cond_nr</span><span class="op">(</span><span class="va">X3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2.242481e+13 1.791760e+04</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">X2</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,
  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">X3</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">X3</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] -6.229745e-09 -6.229745e-09</code></pre>
<hr>
<p>Did subtracting and rescaling help?</p>
<hr>
<p><strong>Solution:</strong></p>
<p>Yes, the condition number was significantly reduced. The correlation between the columns is however still very close to 1, meaning that the matrix is still close to singular.</p>
<hr>
<p>An alternative fix is to subtract the mean <code>x</code> value from the original <code>x</code> vector before defining the quadratic model. Try this and see what happens to the condition number and column correlations of the model matrix. First, construct the modified data:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Data setup:</span>
<span class="va">data4</span> <span class="op">&lt;-</span> <span class="va">data2</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>x_shifted <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x_shifted</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x_shifted</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data4</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">mod4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial08Solutions_files/figure-html/unnamed-chunk-24-1.png" width="576"></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">X4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">mod4</span><span class="op">)</span>
<span class="fu">cond_nr</span><span class="op">(</span><span class="va">X4</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 15.36915</code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">X4</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">X4</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] -0.09094755</code></pre>
<hr>
<p>Different methods for modifying the inputs and model definitions require different calculations for compensating in the model parameters, and has to be figured out for each case separately. The most common effect is to change the interpretation of the <span class="math inline">\(\beta_0\)</span> parameter.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Finn Lindgren.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
