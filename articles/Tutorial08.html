<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tutorial 08: Floating point computations and least squares • StatCompLab</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial 08: Floating point computations and least squares">
<meta name="description" content="Statistical Computing: Lab tutorial 8">
<meta property="og:description" content="Statistical Computing: Lab tutorial 8">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">StatCompLab</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">25.4.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Project_Example_Solution.html">StatComp Project Example Solution: Numerical Statistics</a></li>
    <li><a class="dropdown-item" href="../articles/Project_Example.html">StatComp Project Example: Numerical statistics</a></li>
    <li><a class="dropdown-item" href="../articles/Project01.html">StatComp Project 1 (2022/23): Simulation and sampling</a></li>
    <li><a class="dropdown-item" href="../articles/Project01Hints.html">StatComp Project 1 (2022/23): Hints</a></li>
    <li><a class="dropdown-item" href="../articles/Project02.html">StatComp Project 2: Scottish weather</a></li>
    <li><a class="dropdown-item" href="../articles/Project02Hints.html">StatComp Project 2 (2022/23): Hints</a></li>
    <li><a class="dropdown-item" href="../articles/Quiz1Solution.html">Quiz 1 Solution (StatComp 2021/22)</a></li>
    <li><a class="dropdown-item" href="../articles/T4sol.html">Tutorial 04: Uncertainty and integration (full solution)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial01.html">Tutorial 01: R and linear models</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial01Solutions.html">Tutorial 01: R and linear models (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial02.html">Tutorial 02: Optimization</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial02Solutions.html">Tutorial 02: Optimization (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial03.html">Tutorial 03: Monte Carlo integration</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial03Solutions.html">Tutorial 03: Monte Carlo integration (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial04.html">Tutorial 04: Uncertainty and integration</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial04Solutions.html">Tutorial 04: Uncertainty and integration (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial06.html">Tutorial 06: Prediction assessment with proper scores</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial06Solutions.html">Tutorial 06: Prediction assessment with proper scores (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial07.html">Tutorial 07: Data wrangling and cross validation</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial07Solutions.html">Tutorial 07: Data wrangling and cross validation (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial08.html">Tutorial 08: Floating point computations and least squares</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial08Solutions.html">Tutorial 08: Floating point computations and least squares (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial09.html">Tutorial 09: Bootstrap and Pareto smoothed importance sampling</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial09Solutions.html">Tutorial 09: Bootstrap and Pareto smoothed importance sampling (solutions)</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/finnlindgren/StatCompLab/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Tutorial 08: Floating point computations and least squares</h1>
                        <h4 data-toc-skip class="author">Finn
Lindgren</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/finnlindgren/StatCompLab/blob/main/vignettes/Tutorial08.Rmd" class="external-link"><code>vignettes/Tutorial08.Rmd</code></a></small>
      <div class="d-none name"><code>Tutorial08.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this lab session you will explore</p>
<ul>
<li>Speed of matrix computations</li>
<li>Floating point accuracy in least squares estimation of statistical
linear models</li>
</ul>
<ol style="list-style-type: decimal">
<li>Open your github repository clone project from Lab 2 or 4 and
upgrade the <code>StatCompLab</code> package</li>
<li>During this lab, you can work in a <code>.R</code> file, but working
with code chunks in a <code>.Rmd</code> is highly recommended.</li>
</ol>
<p>For measuring relative running times of different methods, we’ll use
the <code>bench</code> package. You won’t need to load the package with
<code>library</code>. Instead, check if <code><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">bench::mark()</a></code> runs
without errors. If it doesn’t, and it’s because the package is not
installed, then install it with <code>install.packages("bench")</code>
in the R Console.</p>
<p>Suggested code for the setup code chunk:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://finnlindgren.github.io/StatCompLab">StatCompLab</a></span><span class="op">)</span></span></code></pre></div>
<hr>
<p><strong>Solution:</strong></p>
<p>The accompanying <code>Tutorial08Solutions</code> tutorial/vignette
documents contain the solutions explicitly, to make it easier to review
the material after the workshops.</p>
<hr>
</div>
<div class="section level2">
<h2 id="numerical-speed">Numerical speed<a class="anchor" aria-label="anchor" href="#numerical-speed"></a>
</h2>
<p>Define the following function for computing a vector norm:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_norm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">0.5</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Try it on a simple vector where you can verify that the result is
correct, e.g.<br></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">vec_norm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">4</span> <span class="op">+</span> <span class="fl">9</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3.741657 3.741657</span></span></code></pre>
<p>We will now take a look at the computational speed of matrix
operations.</p>
<p>First construct a vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐛</mi><annotation encoding="application/x-tex">\boldsymbol{b}</annotation></semantics></math>
and matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\boldsymbol{A}</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100000</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">m</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">m</span><span class="op">)</span></span></code></pre></div>
<p>Let’s check the speed difference between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝐀</mi><mi>⊤</mi></msup><mi>𝐛</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{A}^\top\boldsymbol{b}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>𝐛</mi><mi>⊤</mi></msup><mi>𝐀</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>⊤</mi></msup><annotation encoding="application/x-tex">(\boldsymbol{b}^\top\boldsymbol{A})^\top</annotation></semantics></math>
(convince yourself that the two expressions would be equivalent in exact
arithmetic, and possibly also in floating point arithmetic). The
function <code><a href="https://rdrr.io/r/base/t.html" class="external-link">t()</a></code> construct the transpose of a matrix. Note that
when <code>b</code> is a vector (as opposed to a single-column matrix)
it is interpreted as either a column vector or a row vector, depending
on the operation. When <code>b</code> is a vector,
<code>as.matrix(b)</code> is always a single-column matrix, and
<code>t(b)</code> is a single-row matrix, but <code>b %*% A</code> is
interpreted as <code>t(b) %*% A</code>.</p>
<p>Which method for computing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝐀</mi><mi>⊤</mi></msup><mi>𝐛</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{A}^\top \boldsymbol{b}</annotation></semantics></math>
is faster? Use <code><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">bench::mark()</a></code> to compare the different ways
of evaluating the expression. By extracting the variables
<code>expression</code>, <code>median</code>, and <code>itr/sec</code>
from the <code><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">bench::mark()</a></code> output using the
<code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select()</a></code> function, we can summarise the results in a
table.</p>
<!--


-->
<p>To save typing, define a function <code>bench_table</code> that does
the <code>kable</code> printing:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bench_table</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>    <span class="va">bm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">expression</span>, <span class="va">median</span>, <span class="va">`itr/sec`</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<!--

The `t(A) %*% b` method is the slowest implementation.
Transposing a matrix requires copying the values to new locations.
Transposing a vector doesn't require any copying.
-->
<p>For
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐀</mi><mi>𝐁</mi><mi>𝐛</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{A}\boldsymbol{B}\boldsymbol{b}</annotation></semantics></math>,
the order in which matrix&amp;vector multiplication is done is
important. Define these new variables:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, <span class="va">m</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p>Compare the running times of <code>A %*% B %*% b</code>,
<code>(A %*% B) %*% b</code>, and <code>A %*% (B %*% b))</code>.</p>
<!--


-->
<p>The three versions should produce very similar numerical results
(<code><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">bench::mark</a></code> will complain if they don’t) Which method is
fastest? Why? Are the computed results the same?</p>
<!--

One matrix-matrix multiplication is very expensive compared with matrix-vector multiplication.
The results are numerically very close, and one can likely express bounds for them in terms of
`.Machine$double.eps` and $m,n,p$.
-->
<p>For a square matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\boldsymbol{A}</annotation></semantics></math>
of size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mo>×</mo><mn>1000</mn></mrow><annotation encoding="application/x-tex">1000\times 1000</annotation></semantics></math>,
compare the cost of <code>solve(A) %*% b</code> (Get the matrix inverse
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>𝐀</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">\boldsymbol{A}^{-1}</annotation></semantics></math>,
then multiply with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐛</mi><annotation encoding="application/x-tex">\boldsymbol{b}</annotation></semantics></math>)
against the cost of <code>solve(A, b)</code> (Solve the linear system
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐀</mi><mi>𝐮</mi><mo>=</mo><mi>𝐛</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{A}\boldsymbol{u}=\boldsymbol{b}</annotation></semantics></math>).</p>
<!--


-->
</div>
<div class="section level2">
<h2 id="numerical-least-squares-estimation">Numerical Least Squares estimation<a class="anchor" aria-label="anchor" href="#numerical-least-squares-estimation"></a>
</h2>
<p>You’ll now investigate some numerical issues when doing numerical
least squares estimation.</p>
<p>Run the following code that generates synthetic observations from a
linear model
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>y</mi><mi>i</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mn>100.5</mn></mrow><mn>5</mn></mfrac><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mn>100.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mo>+</mo><msub><mi>e</mi><mi>i</mi></msub><mo>,</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
y_i &amp;= \frac{x_i-100.5}{5} + (x_i-100.5)^2 + e_i,
\end{aligned}
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub><mo>∼</mo><mrow><mi>𝖭</mi><mi>𝗈</mi><mi>𝗋</mi><mi>𝗆</mi><mi>𝖺</mi><mi>𝗅</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msub><mi>σ</mi><mi>e</mi></msub><mo>=</mo><mn>0.1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">e_i \sim \mathsf{Normal}(0, \sigma_e=0.1)</annotation></semantics></math>,
independent,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>n</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">i=1,\dots,n=100</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Set the "seed" for the random number sequences, so we can</span></span>
<span><span class="co">## reproduce exactly the same random numbers every time we run the code</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">## Simulate the data</span></span>
<span><span class="co"># x: 100 random numbers between 100 and 101</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># y: random variation around a quadratic function:</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">100.5</span><span class="op">)</span> <span class="op">/</span> <span class="fl">5</span> <span class="op">+</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">100.5</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot the data we have stored in the
<code>data.frame</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>What are the true values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>1</mn></msub><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>2</mn></msub><annotation encoding="application/x-tex">\beta_2</annotation></semantics></math>
in the standardised model formulation,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>y</mi><mi>i</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>μ</mi><mi>i</mi></msub><mo>+</mo><msub><mi>e</mi><mi>i</mi></msub><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><msubsup><mi>x</mi><mi>i</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>e</mi><mi>i</mi></msub><mi>?</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
y_i &amp;= \mu_i + e_i = \beta_0 + \beta_1 x_i + \beta_2 x_i^2 + e_i ?
\end{aligned}
</annotation></semantics></math> Hint: Identify the values by matching
the terms when expanding the initial model definition above.</p>
<!--

$$
\begin{aligned}
\beta_0 &= -\frac{100.5}{5} + 100.5^2 = 10080.15 \\
\beta_1 &= \frac{1}{5} - 201 = -200.8 \\
\beta_2 &= 1
\end{aligned}
$$
-->
<p>Create a <code>beta_true</code> vector containing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mn>0</mn></msub><mo>,</mo><msub><mi>β</mi><mn>1</mn></msub><mo>,</mo><msub><mi>β</mi><mn>2</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(\beta_0, \beta_1, \beta_2)</annotation></semantics></math>:</p>
<!--


-->
<p>Use these
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>-values
to plot the quadratic true model predictor function as a function of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mn>100</mn><mo>,</mo><mn>101</mn><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">x\in[100,101]</annotation></semantics></math>,
together with the observations, and the estimate provided by
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>. Since the observed
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
values are relatively dense, we don’t necessarily need a special plot
sequence of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
values, but can reuse the observed values, and the model predictions for
those value can be obtained with the <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code> method. In
the <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> formula specification, use <code>+ I(x^2)</code>
for the quadratic term. This tells <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> to first compute
<code>x^2</code>, and then use the result as a new covariate. The
<code><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I()</a></code> method can be interpreted as “use the computed value of
this instead of other possible special meanings of the expression”.</p>
<!--

<img src="Tutorial08_files/figure-html/unnamed-chunk-13-1.png" width="576" />
-->
<p>Use the <code>model.matrix(mod1)</code> function to extract the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐗</mi><annotation encoding="application/x-tex">\boldsymbol{X}</annotation></semantics></math>
matrix for the vector formulation of the model,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐲</mi><mo>=</mo><mi>𝐗</mi><mi>𝛃</mi><mo>+</mo><mi>𝐞</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{y}=\boldsymbol{X}\boldsymbol{\beta}+\boldsymbol{e}</annotation></semantics></math>,
and store in <code>X1</code>. (See <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">?model.matrix</a></code> for more
information). Then use the direct <em>normal equations</em> solve shown
in Lecture 8,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>𝐗</mi><mi>⊤</mi></msup><mi>𝐗</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><msup><mi>𝐗</mi><mi>⊤</mi></msup><mi>𝐲</mi></mrow><annotation encoding="application/x-tex">(\boldsymbol{X}^\top\boldsymbol{X})^{-1}\boldsymbol{X}^\top\boldsymbol{y}</annotation></semantics></math>,
to estimate the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
parameters. Does it work?</p>
<!--


```
## Error in solve.default(t(X1) %*% X1, t(X1) %*% data$y) : 
##   system is computationally singular: reciprocal condition number = 3.98647e-19
```
-->
</div>
<div class="section level2">
<h2 id="shifted-covariate">Shifted covariate<a class="anchor" aria-label="anchor" href="#shifted-covariate"></a>
</h2>
<p>What if the whole model was shifted to the right, so that we were
given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>+</mo><mn>1000</mn></mrow><annotation encoding="application/x-tex">x+1000</annotation></semantics></math>
instead of the original
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>-values?
The model expression would still be able to represent the same quadratic
expression but with different
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
values. Create a new data set:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data2</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>Estimate the model using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> for this new data set.
Does it work?</p>
<!--

<img src="Tutorial08_files/figure-html/unnamed-chunk-16-1.png" width="576" />
`lm()` fails to fit the correct curve, without warning!
-->
<p>The default for <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> is to allow singular models, and
“fix” the problem by removing co-linear columns of the model matrix. We
can ask it to disallow singular models with the <code>singular.ok</code>
argument.</p>
<!--


```
## Error in lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) : 
##   singular fit encountered
```
-->
<p>Define a function <code>cond_nr()</code> taking a matrix
<code>X</code> as input and returning the condition number, computed
with the help of <code>svd</code> (see Lecture 8 for a code example for
the condition number).</p>
<!--


-->
<p>With the help of <code>model.matrix</code>, examine the condition
numbers of the model matrices in the two cases from the previous tasks.
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> computes the fit using the QR decomposition approach,
not by direct solution of the normal equations. Why was the second
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> fit so bad?</p>
<!--


```
## [1] 1560769713
```

```
## [1] 2.242481e+13
```
-->
<p>Plot the second and third columns of the model matrix <code>X2</code>
against each other, and use <code>cor</code> to examine their
correlation (see <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">?cor</a></code>). How does this explain the large
condition number?</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">X2</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Correlation ="</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">X2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">X2</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Very close to co-linear</span></span></code></pre></div>
<!--

In both cases the columns are virtually co-linear, which leads to a very small $d_3$ value, and therefore a large condition number.
-->
<p>Since the linear model says simply that the expected value vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝖤</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathsf{E}(\boldsymbol{y})</annotation></semantics></math>
lies in the space spanned by the columns of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐗</mi><annotation encoding="application/x-tex">\boldsymbol{X}</annotation></semantics></math>,
one possibility is to attempt to arrive at a better conditioned
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐗</mi><annotation encoding="application/x-tex">\boldsymbol{X}</annotation></semantics></math>
by linear rescaling and/or recombination of its columns. This is always
equivalent to a linear re-parameterization.</p>
<p>Try this on the model matrix of the model that causes
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> to fail. In particular, for each column (except the
intercept column) subtract the column mean (e.g., try the
<code><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep()</a></code> and <code><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans()</a></code> functions, see example
code below). Then divide each column (except the intercept column) by
its standard deviation. Find the condition number of the new model
matrix. Fit the model with this model matrix using something like
<code>mod3 &lt;- lm(y ~ x1 + x2 + x3 - 1, data = data3)</code></p>
<p>Produce a plot that confirms that the resulting fit is sensible
now.</p>
<!--

<img src="Tutorial08_files/figure-html/unnamed-chunk-21-1.png" width="576" />
-->
<p>Note: If the data is split into estimation and test sets, the same
transformation must be applied to the test data, using the scaling
parameters derived from the observation data. Therefore the
<code><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale()</a></code> function isn’t very useful for this. Instead,
explicitly computing and storing the transformation information is
necessary.</p>
<p>Compute the condition numbers for <code>X2</code> and
<code>X3</code>. Also compute the correlation between column 2 and 3 of
<code>X3</code> (subtract
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>
to see how close to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>
it is).</p>
<!--


```
## [1] 2.242481e+13 1.791760e+04
```

```
## [1] -6.229745e-09 -6.229745e-09
```
-->
<p>Did subtracting and rescaling help?</p>
<!--

Yes, the condition number was significantly reduced.  The correlation between the columns is however still very close to 1, meaning that the matrix is still close to singular.
-->
<p>An alternative fix is to subtract the mean <code>x</code> value from
the original <code>x</code> vector before defining the quadratic model.
Try this and see what happens to the condition number and column
correlations of the model matrix. First, construct the modified
data:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Data setup:</span></span>
<span><span class="va">data4</span> <span class="op">&lt;-</span> <span class="va">data2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>x_shifted <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!--

<img src="Tutorial08_files/figure-html/unnamed-chunk-24-1.png" width="576" />

```
## [1] 15.36915
```

```
## [1] -0.09094755
```
-->
<p>Different methods for modifying the inputs and model definitions
require different calculations for compensating in the model parameters,
and has to be figured out for each case separately. The most common
effect is to change the interpretation of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math>
parameter.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Finn Lindgren.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
