<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial 09: Bootstrap and Pareto smoothed importance sampling â€¢ StatCompLab</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial 09: Bootstrap and Pareto smoothed importance sampling">
<meta property="og:description" content="Statistical Computing: Lab tutorial 9">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">StatCompLab</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">21.9.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Project01.html">StatComp Project 1 (2021/22): Simulation and sampling</a>
    </li>
    <li>
      <a href="../articles/Project01Hints.html">Project 01 Hints</a>
    </li>
    <li>
      <a href="../articles/Tutorial01.html">Tutorial 01: R and linear models</a>
    </li>
    <li>
      <a href="../articles/Tutorial01Solutions.html">Tutorial 01: R and linear models (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial02.html">Tutorial 02: Optimization</a>
    </li>
    <li>
      <a href="../articles/Tutorial02Solutions.html">Tutorial 02: Optimization (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial03.html">Tutorial 03: Monte Carlo integration</a>
    </li>
    <li>
      <a href="../articles/Tutorial03Solutions.html">Tutorial 03: Monte Carlo integration (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial04.html">Tutorial 04: Uncertainty and integration</a>
    </li>
    <li>
      <a href="../articles/Tutorial04Solutions.html">Tutorial 04: Uncertainty and integration (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial06.html">Tutorial 06: Prediction assessment with proper scores</a>
    </li>
    <li>
      <a href="../articles/Tutorial06Solutions.html">Tutorial 06: Prediction assessment with proper scores (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial07.html">Tutorial 07: Data wrangling and cross validation</a>
    </li>
    <li>
      <a href="../articles/Tutorial07Solutions.html">Tutorial 07: Data wrangling and cross validation (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial08.html">Tutorial 08: Floating point computations and least squares</a>
    </li>
    <li>
      <a href="../articles/Tutorial08Solutions.html">Tutorial 08: Floating point computations and least squares (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial09.html">Tutorial 09: Bootstrap and Pareto smoothed importance sampling</a>
    </li>
    <li>
      <a href="../articles/Tutorial09Solutions.html">Tutorial 09: Bootstrap and Pareto smoothed importance sampling (solutions)</a>
    </li>
    <li>
      <a href="../articles/Project_Example.html">StatComp Project Example: Numerical statistics</a>
    </li>
    <li>
      <a href="../articles/Project_Example_Solution.html">StatComp Project Example Solution: Numerical Statistics</a>
    </li>
    <li>
      <a href="../articles/Quiz1Solution.html">Quiz 1 Solution (StatComp 2021/22)</a>
    </li>
    <li>
      <a href="../articles/T4sol.html">Tutorial 04: Uncertainty and integration (full solution)</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/finnlindgren/StatCompLab/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Tutorial09_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tutorial 09: Bootstrap and Pareto smoothed importance sampling</h1>
                        <h4 data-toc-skip class="author">Finn Lindgren</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/finnlindgren/StatCompLab/blob/HEAD/vignettes/Tutorial09.Rmd" class="external-link"><code>vignettes/Tutorial09.Rmd</code></a></small>
      <div class="hidden name"><code>Tutorial09.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this lab session you will explore</p>
<ul>
<li>Exchangeability test for prediction scores</li>
<li>Pareto smoothed importance sampling</li>
</ul>
<ol style="list-style-type: decimal">
<li>Open one of your github lab repository clone projects</li>
<li>During this lab, you can work in a <code>.R</code> file, but working with code chunks in a <code>.Rmd</code> is recommended.</li>
<li>Make sure you update the <code>StatCompLab</code> package to version 21.9.0 or higher.</li>
</ol>
<hr>
<p><strong>Solution:</strong> The accompanying <code>Tutorial09Solutions</code> tutorial/vignette documents contain the solutions explicitly, to make it easier to review the material after the workshops.</p>
<hr>
</div>
<div class="section level2">
<h2 id="filement-model-prediction-comparison">Filement model prediction comparison<a class="anchor" aria-label="anchor" href="#filement-model-prediction-comparison"></a>
</h2>
<div class="section level3">
<h3 id="leave-one-out-prediction">Leave-one-out prediction<a class="anchor" aria-label="anchor" href="#leave-one-out-prediction"></a>
</h3>
<p>Revisit the Tutorial 6 and load the 3D printer filament data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"filament1"</span>, package <span class="op">=</span> <span class="st">"StatCompLab"</span><span class="op">)</span></code></pre></div>
<p>In tutorial 6, the two models A and B were estimated with</p>
<p>Predictions and scores were done with</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pred_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filament1_predict.html">filament1_predict</a></span><span class="op">(</span><span class="va">fit_A</span>, newdata <span class="op">=</span> <span class="va">filament1</span><span class="op">)</span>
<span class="va">pred_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filament1_predict.html">filament1_predict</a></span><span class="op">(</span><span class="va">fit_B</span>, newdata <span class="op">=</span> <span class="va">filament1</span><span class="op">)</span>
<span class="va">score_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pred_A</span>, <span class="va">filament1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    se <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"se"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>,
    ds <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"ds"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>,
    interval <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"interval"</span>, <span class="va">Actual_Weight</span>,
                            lwr <span class="op">=</span> <span class="va">lwr</span>, upr <span class="op">=</span> <span class="va">upr</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
  <span class="op">)</span>
<span class="va">score_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pred_B</span>, <span class="va">filament1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    se <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"se"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>,
    ds <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"ds"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>,
    interval <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"interval"</span>, <span class="va">Actual_Weight</span>,
                            lwr <span class="op">=</span> <span class="va">lwr</span>, upr <span class="op">=</span> <span class="va">upr</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>as well as with a 50% estimation/prediction data split.</p>
<p>Implement a function <code>leave1out(data, model)</code> that performs leave-one-out cross validation for the selected <code>model</code>. the two models; for each <span class="math inline">\(i=1,\dots,N\)</span>, estimate the model parameters using <span class="math inline">\(\{(x_j,y_j), j\neq i\}\)</span>, compute the prediction information based on <span class="math inline">\(x_i\)</span> for prediction model <span class="math inline">\(F_i\)</span>, and compute the required scores <span class="math inline">\(S(F_i,y_i)\)</span>.</p>
<p>The output should be a <code>data.frame</code> with <span class="math inline">\(N\)</span> rows that extends the original data frame with four additional columns <code>mean</code>, <code>sd</code>, <code>se</code> and <code>ds</code> of leave-one-out prediction means, standard deviations, and prediction scores for the Squared Error and Dawid-Sebastiani scores.</p>
<!--


-->
<p>The following code should work if your code is correct:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">score_A</span> <span class="op">&lt;-</span> <span class="fu">leave1out</span><span class="op">(</span><span class="va">filament1</span>, model <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>
<span class="va">score_B</span> <span class="op">&lt;-</span> <span class="fu">leave1out</span><span class="op">(</span><span class="va">filament1</span>, model <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">CAD_Weight</span>, <span class="va">se</span>, colour <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">score_A</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">CAD_Weight</span>, <span class="va">se</span>, colour <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">score_B</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">CAD_Weight</span>, <span class="va">ds</span>, colour <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">score_A</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">CAD_Weight</span>, <span class="va">ds</span>, colour <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">score_B</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exchangeability-test">Exchangeability test<a class="anchor" aria-label="anchor" href="#exchangeability-test"></a>
</h3>
<p>We want to investigate whether one model is better at predicting than the other. If they are equivalent, it should not matter, on average, if we randomly swap the A and B prediction scores within each leave-one-out score pair <span class="math inline">\((S^A_i, S^B_i)\)</span>. Use the test statistic <span class="math inline">\(\frac{1}{N}\sum_{i=1}^N (S^A_i - S^B_i)\)</span>, and make a Monte Carlo estimate of the p-value for a test of exchangeability between model predictions from A and from B against the alternative hypothesis that B is better than A. First compute the test statistic for the two prediction scores.</p>
<p>Hints: For this particular test statistic, one possible approach is to first compute the pairwise score differences and then generate randomisation samples by sampling random sign changes. Compute the test statistic for each randomly altered set of values and compare with the original test statistic. See the lecture on exchangeability for more information. Start with <span class="math inline">\(J=1000\)</span> iterations when testing your code. Increase to 10000 for more precise results.</p>
<!--


We see that for the Square Error scores, the two model predictions appear
exchangeable, but when prediction uncertainty is taken into account in the Dawid-Sebastiani
score, B appears to be better than A, on average.
-->
</div>
</div>
<div class="section level2">
<h2 id="pareto-smoothed-importance-sampling">Pareto smoothed importance sampling<a class="anchor" aria-label="anchor" href="#pareto-smoothed-importance-sampling"></a>
</h2>
<p>Explore the Pareto smoothed importance sampling (PSIS) method. Use a t-distribution with 10 degrees of freedom, and importance sampling distribution <span class="math inline">\(x\sim \mathsf{Normal}(0, \sigma^2)\)</span> for different values of <span class="math inline">\(\sigma\)</span>. Use <span class="math inline">\(N=100\)</span> or more samples.</p>
<p>Use the <code><a href="https://mc-stan.org/loo/reference/psis.html" class="external-link">loo::psis()</a></code> function to compute Pareto smoothed importance log-weights and diagnostics. What effect does different values of <span class="math inline">\(\sigma\)</span> have on the <span class="math inline">\(k\)</span> parameter estimate? (the <span class="math inline">\(\hat{k}\)</span> value is in the <code>$diagnostics$pareto_k</code> field of the <code><a href="https://mc-stan.org/loo/reference/psis.html" class="external-link">loo::psis()</a></code> output.) Plot the original and smoothed log-weights as a function of <span class="math inline">\(x\)</span>, and with <code>stat_ecdf</code>, for different values of <span class="math inline">\(\sigma\)</span>, including <span class="math inline">\(\sigma=1\)</span> and <span class="math inline">\(\sigma=2\)</span>.</p>
<!--


-->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Finn Lindgren.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
