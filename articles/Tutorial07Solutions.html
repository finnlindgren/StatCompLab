<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial 07: Data wrangling and cross validation (solutions) • StatCompLab</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial 07: Data wrangling and cross validation (solutions)">
<meta property="og:description" content="Statistical Computing: Lab tutorial 7">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">StatCompLab</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.8.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Lab01.html">Lab01</a>
    </li>
    <li>
      <a href="../articles/Lab02.html">Lab02</a>
    </li>
    <li>
      <a href="../articles/Lab03.html">Lab03</a>
    </li>
    <li>
      <a href="../articles/Project01.html">StatComp Project 1 (2020/21): Numerical statistics</a>
    </li>
    <li>
      <a href="../articles/Project01Hints.html">Project 01 Hints</a>
    </li>
    <li>
      <a href="../articles/Tutorial01.html">Tutorial 01: R and linear models</a>
    </li>
    <li>
      <a href="../articles/Tutorial01Solutions.html">Tutorial 01: R and linear models (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial03.html">Tutorial 03: Monte Carlo integration</a>
    </li>
    <li>
      <a href="../articles/Tutorial03Solutions.html">Tutorial 03: Monte Carlo integration (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial04.html">Tutorial 04: Uncertainty and integration</a>
    </li>
    <li>
      <a href="../articles/Tutorial04Solutions.html">Tutorial 04: Uncertainty and integration (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial06.html">Tutorial 06: Prediction assessment with proper scores</a>
    </li>
    <li>
      <a href="../articles/Tutorial06Solutions.html">Tutorial 06: Prediction assessment with proper scores (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial07.html">Tutorial 07: Data wrangling and cross validation</a>
    </li>
    <li>
      <a href="../articles/Tutorial07Solutions.html">Tutorial 07: Data wrangling and cross validation (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial08.html">Tutorial 08: Floating point computations and least squares</a>
    </li>
    <li>
      <a href="../articles/Tutorial08Solutions.html">Tutorial 08: Floating point computations and least squares (solutions)</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/finnlindgren/StatCompLab/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Tutorial07Solutions_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tutorial 07: Data wrangling and cross validation (solutions)</h1>
                        <h4 class="author">Finn Lindgren</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/finnlindgren/StatCompLab/blob/master/vignettes/Tutorial07Solutions.Rmd"><code>vignettes/Tutorial07Solutions.Rmd</code></a></small>
      <div class="hidden name"><code>Tutorial07Solutions.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>In this lab session you will explore</p>
<ul>
<li>Data wrangling; restructuring data frames</li>
<li>Graphical data exploration</li>
<li>Cross validation</li>
</ul>
<ol style="list-style-type: decimal">
<li>Open your github repository clone project from Lab 2 (either on <a href="https://rstudio.cloud">https://rstudio.cloud</a> or on your own computer and upgrade the <code>StatCompLab</code> package (see the <code>Lab03</code> vignette for more details)</li>
<li>During this lab, you can work in a <code>.R</code> file, but working with code chunks in a <code>.Rmd</code> is recommended.</li>
<li>Make sure you update the <code>StatCompLab</code> package to version 0.7.0 or higher.</li>
</ol>
<!--

The accompanying `Tutorial07Solutions` tutorial/vignette documents contain the
solutions explicitly, to make it easier to review the material after the workshops.
--><p>Throughout this tutorial, you’ll make use of the data wrangling and plotting tools in the <code>dplyr</code>, <code>magrittr</code>, <code>ggplot2</code> and other tidyverse packages, so start your code with <code><a href="http://tidyverse.tidyverse.org">library(tidyverse)</a></code> and <code><a href="https://finnlindgren.github.io/StatCompLab">library(StatCompLab)</a></code>.</p>
<p>Note that the exercises in this tutorial build on each other, often with one solution being similar to previous solutions, with just a few additions and/or modifications.</p>
<p>Some of the data wrangling functions used in the tutorial are</p>
<ul>
<li>
<code>mutate</code> to add or alter variables</li>
<li>
<code>filter</code> to keep only rows fulfilling given criteria</li>
<li>
<code>group_by</code> to perform analyses within subgroups defined by one or more variables</li>
<li>
<code>summarise</code> to compute data summaries, usually with subgroups</li>
<li>
<code>select</code> to keep only some variables</li>
<li>
<code>left_join</code> to join two data frames together, based on common identifier variables</li>
<li>
<code>pivot_wider</code> to split a value variable into new named variables based on a category variable</li>
<li>
<code>pivot_longer</code> to gather several variables into a new single value variable, and the names stored in a new category variable</li>
<li>
<code>%&gt;%</code>, the “pipe” operator used to glue a sequence of operations together by feeding the result of an operation into the first argument of the following function call</li>
<li>
<code>head</code> to view only the first few rows of a data frame. This can be useful when debugging a sequence of “piped” expressions, by placing it last in the pipe sequence</li>
<li>
<code>pull</code> to extract the contents of a single variable</li>
</ul>
<p>Functions for plotting,</p>
<ul>
<li>
<code>ggplot</code> for initialising plots</li>
<li>
<code>geom_point</code> for drwaing points</li>
<li>
<code>facet_wrap</code> for splitting a plot into “facet” plots, based on one or more category variables</li>
</ul>
</div>
<div id="scottish-weather-data" class="section level2">
<h2 class="hasAnchor">
<a href="#scottish-weather-data" class="anchor"></a>Scottish weather data</h2>
<p>The Global Historical Climatology Network at <a href="https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/global-historical-climatology-network-ghcn" class="uri">https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/global-historical-climatology-network-ghcn</a> provides historical weather data collected from all over the globe. A subset of the daily resolution data set (see <a href="https://www.ncdc.noaa.gov/ghcn-daily-description" class="uri">https://www.ncdc.noaa.gov/ghcn-daily-description</a>) is available in the <code>StatCompLab package</code> (from version 0.7.0) containing data from eight weather stations in Scotland, covering the time period from 1 January 1960 to 31 December 2018. Some of the measurements are missing, either due to instrument problems or data collection issues. Load the data with</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">ghcnd_stations</span>, package <span class="op">=</span> <span class="st">"StatCompLab"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">ghcnd_values</span>, package <span class="op">=</span> <span class="st">"StatCompLab"</span><span class="op">)</span></code></pre></div>
<p>The <code>ghcnd_stations</code> data frame has 5 variables:</p>
<ul>
<li>
<code>ID</code>: The identifier code for each station</li>
<li>
<code>Name</code>: The humanly readable station name</li>
<li>
<code>Latitude</code>: The latitude of the station location, in degrees</li>
<li>
<code>Longitude</code>: The longitude of the station location, in degrees</li>
<li>
<code>Elevation</code>: The station elevation, in metres above sea level</li>
</ul>
<p>The station data set is small enough that you can view the whole thing, e.g. with <code><a href="https://rdrr.io/pkg/knitr/man/kable.html">knitr::kable(ghcnd_stations)</a></code>. You can try to find some of the locations on a map (google maps an other online map systems can usually interpret latitude and longitude searches).</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">ghcnd_stations</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">ID</th>
<th align="left">Name</th>
<th align="right">Latitude</th>
<th align="right">Longitude</th>
<th align="right">Elevation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">UKE00105874</td>
<td align="left">BRAEMAR</td>
<td align="right">57.0058</td>
<td align="right">-3.3967</td>
<td align="right">339</td>
</tr>
<tr class="even">
<td align="left">UKE00105875</td>
<td align="left">BALMORAL</td>
<td align="right">57.0367</td>
<td align="right">-3.2200</td>
<td align="right">283</td>
</tr>
<tr class="odd">
<td align="left">UKE00105884</td>
<td align="left">ARDTALNAIG</td>
<td align="right">56.5289</td>
<td align="right">-4.1108</td>
<td align="right">130</td>
</tr>
<tr class="even">
<td align="left">UKE00105885</td>
<td align="left">FASKALLY</td>
<td align="right">56.7181</td>
<td align="right">-3.7689</td>
<td align="right">94</td>
</tr>
<tr class="odd">
<td align="left">UKE00105886</td>
<td align="left">LEUCHARS</td>
<td align="right">56.3767</td>
<td align="right">-2.8617</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">UKE00105887</td>
<td align="left">PENICUIK</td>
<td align="right">55.8239</td>
<td align="right">-3.2258</td>
<td align="right">185</td>
</tr>
<tr class="odd">
<td align="left">UKE00105888</td>
<td align="left">EDINBURGH: ROYAL BOTANIC GARDE</td>
<td align="right">55.9667</td>
<td align="right">-3.2100</td>
<td align="right">26</td>
</tr>
<tr class="even">
<td align="left">UKE00105930</td>
<td align="left">BENMORE: YOUNGER BOTANIC GARDE</td>
<td align="right">56.0281</td>
<td align="right">-4.9858</td>
<td align="right">12</td>
</tr>
</tbody>
</table>
<hr>
<p>The <code>ghcnd_values</code> data frame has 7 variables:</p>
<ul>
<li>
<code>ID</code>: The station identifier code for each observation</li>
<li>
<code>Year</code>: The year the value was measured</li>
<li>
<code>Month</code>: The month the value was measured</li>
<li>
<code>Day</code>: The day of the month the value was measured</li>
<li>
<code>DecYear</code>: “Decimal year”, the measurement date converted to a fractional value, where whole numbers correspond to 1 January, and fractional values correspond to later dates within the year. This is useful for both plotting and modelling.</li>
<li>
<code>Element</code>: One of “TMIN” (minimum temperature), “TMAX” (maximum temperature), or “PRCP” (precipitation), indicating what each value in the <code>Value</code> variable represents</li>
<li>
<code>Value</code>: Daily measured temperature (in degrees Celsius) or precipitation (in mm)</li>
</ul>
<p>The values data object has 502901 rows, so we don’t want to try to view the whole object directly. Instead, we can start by summarising it.</p>
<p>Start by counting how many observations each station has, for each type of measurement. The shortest approach is to use the <code>count()</code> function. A more generalisable approach is to use the <code>group_by()</code>, <code>summarise()</code>, and n() functions. See the description on <code>?count</code> for how <code>count()</code> is connected to the others. To avoid having to create temporary named variables, end the pipe operations with a call to <code><a href="https://rdrr.io/pkg/knitr/man/kable.html">knitr::kable()</a></code>, especially if you’re working in an RMarkdown document.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ghcnd_values</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">ID</span>, <span class="va">Element</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">ID</th>
<th align="left">Element</th>
<th align="right">n</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">UKE00105874</td>
<td align="left">PRCP</td>
<td align="right">20301</td>
</tr>
<tr class="even">
<td align="left">UKE00105874</td>
<td align="left">TMAX</td>
<td align="right">21399</td>
</tr>
<tr class="odd">
<td align="left">UKE00105874</td>
<td align="left">TMIN</td>
<td align="right">21277</td>
</tr>
<tr class="even">
<td align="left">UKE00105875</td>
<td align="left">PRCP</td>
<td align="right">20668</td>
</tr>
<tr class="odd">
<td align="left">UKE00105875</td>
<td align="left">TMAX</td>
<td align="right">21514</td>
</tr>
<tr class="even">
<td align="left">UKE00105875</td>
<td align="left">TMIN</td>
<td align="right">21523</td>
</tr>
<tr class="odd">
<td align="left">UKE00105884</td>
<td align="left">PRCP</td>
<td align="right">20575</td>
</tr>
<tr class="even">
<td align="left">UKE00105884</td>
<td align="left">TMAX</td>
<td align="right">20861</td>
</tr>
<tr class="odd">
<td align="left">UKE00105884</td>
<td align="left">TMIN</td>
<td align="right">20856</td>
</tr>
<tr class="even">
<td align="left">UKE00105885</td>
<td align="left">PRCP</td>
<td align="right">19449</td>
</tr>
<tr class="odd">
<td align="left">UKE00105885</td>
<td align="left">TMAX</td>
<td align="right">19451</td>
</tr>
<tr class="even">
<td align="left">UKE00105885</td>
<td align="left">TMIN</td>
<td align="right">19547</td>
</tr>
<tr class="odd">
<td align="left">UKE00105886</td>
<td align="left">PRCP</td>
<td align="right">21550</td>
</tr>
<tr class="even">
<td align="left">UKE00105886</td>
<td align="left">TMAX</td>
<td align="right">21548</td>
</tr>
<tr class="odd">
<td align="left">UKE00105886</td>
<td align="left">TMIN</td>
<td align="right">21548</td>
</tr>
<tr class="even">
<td align="left">UKE00105887</td>
<td align="left">PRCP</td>
<td align="right">20684</td>
</tr>
<tr class="odd">
<td align="left">UKE00105887</td>
<td align="left">TMAX</td>
<td align="right">21087</td>
</tr>
<tr class="even">
<td align="left">UKE00105887</td>
<td align="left">TMIN</td>
<td align="right">21130</td>
</tr>
<tr class="odd">
<td align="left">UKE00105888</td>
<td align="left">PRCP</td>
<td align="right">21184</td>
</tr>
<tr class="even">
<td align="left">UKE00105888</td>
<td align="left">TMAX</td>
<td align="right">21483</td>
</tr>
<tr class="odd">
<td align="left">UKE00105888</td>
<td align="left">TMIN</td>
<td align="right">21540</td>
</tr>
<tr class="even">
<td align="left">UKE00105930</td>
<td align="left">PRCP</td>
<td align="right">21184</td>
</tr>
<tr class="odd">
<td align="left">UKE00105930</td>
<td align="left">TMAX</td>
<td align="right">21015</td>
</tr>
<tr class="even">
<td align="left">UKE00105930</td>
<td align="left">TMIN</td>
<td align="right">21527</td>
</tr>
</tbody>
</table>
<hr>
</div>
<div id="exploratory-plotting" class="section level2">
<h2 class="hasAnchor">
<a href="#exploratory-plotting" class="anchor"></a>Exploratory plotting</h2>
<p>Before, we only looked at the station data and weather measurements separately. When plotting, we would at least like to have access to the station <em>names</em> instead of the <em>identifying codes</em>, to give a more humanly readable presentation.</p>
<p>This can be accomplished with the <code>left_join()</code> function, that can add copies of the rows from one data frame to another, where one or more columns match. Create a new variable, <code>ghcnd</code> that for each observation contains both the measurements and the station data:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ghcnd</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">ghcnd_values</span>, <span class="va">ghcnd_stations</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ghcnd</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 11
##   ID           Year Month   Day DecYear Element Value Name    Latitude Longitude
##   &lt;chr&gt;       &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;
## 1 UKE00105874  1960     1     1   1960  TMAX      3.9 BRAEMAR     57.0     -3.40
## 2 UKE00105874  1960     1     1   1960  TMIN      3.3 BRAEMAR     57.0     -3.40
## 3 UKE00105874  1960     1     2   1960. TMAX      7.2 BRAEMAR     57.0     -3.40
## 4 UKE00105874  1960     1     2   1960. TMIN     -8.3 BRAEMAR     57.0     -3.40
## 5 UKE00105874  1960     1     3   1960. TMAX      6.7 BRAEMAR     57.0     -3.40
## 6 UKE00105874  1960     1     3   1960. TMIN     -6.7 BRAEMAR     57.0     -3.40
## # … with 1 more variable: Elevation &lt;dbl&gt;</code></pre>
<p>Now plot daily minimum and maximum temperature measurements connected by lines as a function of time (<code>DecYear</code>), with a different colour for each element, and a separate subplot for each station (<code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap(~variablename)</a></code>), labeled by the station names.</p>
<p>Again, avoid creating a temporary named variable. Instead, feed the initial data wrangling result into <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> directly.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ghcnd</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Element</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TMIN"</span>, <span class="st">"TMAX"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">DecYear</span>, <span class="va">Value</span>, colour <span class="op">=</span> <span class="va">Element</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Name</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial07Solutions_files/figure-html/sum2-show-1.png" width="576"></p>
<hr>
<p>Due to the amount of data, it’s difficult to see clear patterns here. Produce two figures, one showing the yearly averages of TMIN and TMAX as points, and one showing the monthly seasonal averages (for months 1 through 12) of TMIN and TMAX, separately for each station.</p>
<p>Again, avoid creating a temporary named variable. In the previous code, insert calls to <code>group_by()</code> and <code>summarise()</code>, and modify the x-values in the aesthetics.</p>
<p>What are the common patterns in the yearly values, and in the monthly seasonal values?</p>
<hr>
<p><strong>Solution:</strong></p>
<p>The yearly averages all seem to have a slight increasing trend:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ghcnd</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Element</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TMIN"</span>, <span class="st">"TMAX"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span>, <span class="va">Name</span>, <span class="va">Element</span>, <span class="va">Year</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>Value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">Value</span>, colour <span class="op">=</span> <span class="va">Element</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Name</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial07Solutions_files/figure-html/sum3-show-1.png" width="576"></p>
<p>The monthly seasonal averages clearly show the seasonal pattern. The shapes are similar for all stations, but the average and amplitude varies a bit:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ghcnd</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Element</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TMIN"</span>, <span class="st">"TMAX"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span>, <span class="va">Name</span>, <span class="va">Element</span>, <span class="va">Month</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>Value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Month</span>, <span class="va">Value</span>, colour <span class="op">=</span> <span class="va">Element</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Name</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial07Solutions_files/figure-html/sum4-show-1.png" width="576"></p>
<hr>
<div id="scatter-plots" class="section level3">
<h3 class="hasAnchor">
<a href="#scatter-plots" class="anchor"></a>Scatter plots</h3>
<p>If we want to do a scatter plot of TMIN and TMAX, we need to rearrange the data a bit. For this we can use the <code>pivot_wider</code> function, that can turn a <em>name</em> variable and a <em>values</em> variable into several named variable. Note that if only some measurement elements are present on a given day, NA’s will be produced by default. Optionally, filter these rows out before calling <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>.</p>
<p>Draw a scatterplot for daily TMIN vs TMAX for each station, with colour determined by the month.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ghcnd</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">Element</span>, values_from <span class="op">=</span> <span class="va">Value</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">TMIN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">TMAX</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">TMIN</span>, <span class="va">TMAX</span>, colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Month</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Name</span><span class="op">)</span></code></pre></div>
<p><img src="Tutorial07Solutions_files/figure-html/sum5-show-1.png" width="576"></p>
<hr>
</div>
</div>
<div id="cross-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#cross-validation" class="anchor"></a>Cross validation</h2>
<p>Choose one of the stations, and create a new data variable <code>data</code> from <code>ghcnd</code> with the yearly averages of TMIN as a column (as in the previous <code>pivot_wider</code> output), with missing values removed with <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">ghcnd</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="st">"UKE00105875"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">Element</span>, values_from <span class="op">=</span> <span class="va">Value</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">TMIN</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span>, <span class="va">Name</span>, <span class="va">Year</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>TMIN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">TMIN</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></code></pre></div>
<hr>
<div id="within-sample-assessment" class="section level3">
<h3 class="hasAnchor">
<a href="#within-sample-assessment" class="anchor"></a>Within-sample assessment</h3>
<p>Now, using the whole <code>data</code> estimate a linear model for TMIN, with <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> formula <code>TMIN ~ 1 + Year</code>, and compute the average 80% Interval score (use <code><a href="../reference/proper_score.html">proper_score()</a></code> that you used in lab 6) for prediction intervals for each of the TMIN observations in <code>data</code>. See <code><a href="https://rdrr.io/r/stats/predict.lm.html">?predict.lm</a></code> for documentation for the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> method for models estimated with <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">TMIN</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">Year</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="va">pred0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit0</span>, newdata <span class="op">=</span> <span class="va">data</span>,
                 interval <span class="op">=</span> <span class="st">"prediction"</span>, level <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>
<span class="va">score0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span>
  <span class="st">"interval"</span>, <span class="va">data</span><span class="op">$</span><span class="va">TMIN</span>,
  lwr <span class="op">=</span> <span class="va">pred0</span><span class="op">[</span>, <span class="st">"lwr"</span><span class="op">]</span>, upr <span class="op">=</span> <span class="va">pred0</span><span class="op">[</span>,<span class="st">"upr"</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<hr>
</div>
<div id="cross-validation-1" class="section level3">
<h3 class="hasAnchor">
<a href="#cross-validation-1" class="anchor"></a>Cross validation</h3>
<p>We now want to compute the 5 average 80% Interval scores from 5-fold cross validation based on a random partition of the data into 5 approximately equal parts.</p>
<p>First add a new column Group to data defining the partitioning, using <code>mutate()</code>. One approach is to compute a random permutation index vector, and then use the modulus operator <code><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></code> to reduce it to 5 values.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> 
  <span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>Group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
         Group <span class="op">=</span> <span class="op">(</span><span class="va">Group</span> <span class="op">%%</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<hr>
<p>Then loop over the partition groups, estimating the model leaving the group out, and then predicting and scoring predictions for the group.</p>
<p>Compare the resulting scores with the one based on the whole data set. Is the average cross validation score larger or smaller?</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">grp</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">TMIN</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">Year</span>, data <span class="op">=</span> <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Group</span> <span class="op">!=</span> <span class="va">grp</span><span class="op">)</span><span class="op">)</span>
  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Group</span> <span class="op">==</span> <span class="va">grp</span><span class="op">)</span>,
                     interval <span class="op">=</span> <span class="st">"prediction"</span>, level <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>
  <span class="va">scores</span><span class="op">[</span><span class="va">grp</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span>
    <span class="st">"interval"</span>,
    <span class="op">(</span><span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Group</span> <span class="op">==</span> <span class="va">grp</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="st">"TMIN"</span><span class="op">)</span>,
    lwr <span class="op">=</span> <span class="va">pred</span><span class="op">[</span>, <span class="st">"lwr"</span><span class="op">]</span>, upr <span class="op">=</span> <span class="va">pred</span><span class="op">[</span>,<span class="st">"upr"</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The average cross validation score for this problem is usually larger than the one for the whole data set; it’s is intended to reduce the risk of underestimating the prediction error, so this is what we would expect. Repeat the random group allocation to see how much it influences the cross validation score average.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="st">"Whole data score"</span> <span class="op">=</span> <span class="va">score0</span>,
                        <span class="st">"Cross validation score"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Whole.data.score</th>
<th align="right">Cross.validation.score</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">1.400015</td>
<td align="right">1.424231</td>
</tr></tbody>
</table>
<hr>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Finn Lindgren.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
