<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tutorial 09: Bootstrap and Pareto smoothed importance sampling (solutions) • StatCompLab</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial 09: Bootstrap and Pareto smoothed importance sampling (solutions)">
<meta name="description" content="Statistical Computing: Lab tutorial 9">
<meta property="og:description" content="Statistical Computing: Lab tutorial 9">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">StatCompLab</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">25.4.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Project_Example_Solution.html">StatComp Project Example Solution: Numerical Statistics</a></li>
    <li><a class="dropdown-item" href="../articles/Project_Example.html">StatComp Project Example: Numerical statistics</a></li>
    <li><a class="dropdown-item" href="../articles/Project01.html">StatComp Project 1 (2022/23): Simulation and sampling</a></li>
    <li><a class="dropdown-item" href="../articles/Project01Hints.html">StatComp Project 1 (2022/23): Hints</a></li>
    <li><a class="dropdown-item" href="../articles/Project02.html">StatComp Project 2: Scottish weather</a></li>
    <li><a class="dropdown-item" href="../articles/Project02Hints.html">StatComp Project 2 (2022/23): Hints</a></li>
    <li><a class="dropdown-item" href="../articles/Quiz1Solution.html">Quiz 1 Solution (StatComp 2021/22)</a></li>
    <li><a class="dropdown-item" href="../articles/T4sol.html">Tutorial 04: Uncertainty and integration (full solution)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial01.html">Tutorial 01: R and linear models</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial01Solutions.html">Tutorial 01: R and linear models (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial02.html">Tutorial 02: Optimization</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial02Solutions.html">Tutorial 02: Optimization (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial03.html">Tutorial 03: Monte Carlo integration</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial03Solutions.html">Tutorial 03: Monte Carlo integration (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial04.html">Tutorial 04: Uncertainty and integration</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial04Solutions.html">Tutorial 04: Uncertainty and integration (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial06.html">Tutorial 06: Prediction assessment with proper scores</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial06Solutions.html">Tutorial 06: Prediction assessment with proper scores (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial07.html">Tutorial 07: Data wrangling and cross validation</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial07Solutions.html">Tutorial 07: Data wrangling and cross validation (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial08.html">Tutorial 08: Floating point computations and least squares</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial08Solutions.html">Tutorial 08: Floating point computations and least squares (solutions)</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial09.html">Tutorial 09: Bootstrap and Pareto smoothed importance sampling</a></li>
    <li><a class="dropdown-item" href="../articles/Tutorial09Solutions.html">Tutorial 09: Bootstrap and Pareto smoothed importance sampling (solutions)</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/finnlindgren/StatCompLab/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Tutorial 09: Bootstrap and Pareto smoothed importance sampling (solutions)</h1>
                        <h4 data-toc-skip class="author">Finn
Lindgren</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/finnlindgren/StatCompLab/blob/main/vignettes/Tutorial09Solutions.Rmd" class="external-link"><code>vignettes/Tutorial09Solutions.Rmd</code></a></small>
      <div class="d-none name"><code>Tutorial09Solutions.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this lab session you will explore</p>
<ul>
<li>Exchangeability test for prediction scores</li>
<li>Pareto smoothed importance sampling</li>
</ul>
<ol style="list-style-type: decimal">
<li>Open one of your github lab repository clone projects</li>
<li>During this lab, you can work in a <code>.R</code> file, but working
with code chunks in a <code>.Rmd</code> is recommended.</li>
<li>Make sure you update the <code>StatCompLab</code> package to version
21.9.0 or higher.</li>
</ol>
<!--
 The accompanying `Tutorial09Solutions`
tutorial/vignette documents contain the solutions explicitly, to make it
easier to review the material after the workshops.
-->
</div>
<div class="section level2">
<h2 id="filement-model-prediction-comparison">Filement model prediction comparison<a class="anchor" aria-label="anchor" href="#filement-model-prediction-comparison"></a>
</h2>
<div class="section level3">
<h3 id="leave-one-out-prediction">Leave-one-out prediction<a class="anchor" aria-label="anchor" href="#leave-one-out-prediction"></a>
</h3>
<p>Revisit the Tutorial 6 and load the 3D printer filament data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"filament1"</span>, package <span class="op">=</span> <span class="st">"StatCompLab"</span><span class="op">)</span></span></code></pre></div>
<p>In tutorial 6, the two models A and B were estimated with</p>
<p>Predictions and scores were done with</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filament1_predict.html">filament1_predict</a></span><span class="op">(</span><span class="va">fit_A</span>, newdata <span class="op">=</span> <span class="va">filament1</span><span class="op">)</span></span>
<span><span class="va">pred_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filament1_predict.html">filament1_predict</a></span><span class="op">(</span><span class="va">fit_B</span>, newdata <span class="op">=</span> <span class="va">filament1</span><span class="op">)</span></span>
<span><span class="va">score_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pred_A</span>, <span class="va">filament1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    se <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"se"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>,</span>
<span>    ds <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"ds"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>,</span>
<span>    interval <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"interval"</span>, <span class="va">Actual_Weight</span>,</span>
<span>                            lwr <span class="op">=</span> <span class="va">lwr</span>, upr <span class="op">=</span> <span class="va">upr</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">score_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pred_B</span>, <span class="va">filament1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    se <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"se"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>,</span>
<span>    ds <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"ds"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>,</span>
<span>    interval <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"interval"</span>, <span class="va">Actual_Weight</span>,</span>
<span>                            lwr <span class="op">=</span> <span class="va">lwr</span>, upr <span class="op">=</span> <span class="va">upr</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>as well as with a 50% estimation/prediction data split.</p>
<p>Implement a function <code>leave1out(data, model)</code> that
performs leave-one-out cross validation for the selected
<code>model</code>. the two models; for each
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">i=1,\dots,N</annotation></semantics></math>,
estimate the model parameters using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo>,</mo><msub><mi>y</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mi>j</mi><mo>≠</mo><mi>i</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{(x_j,y_j), j\neq i\}</annotation></semantics></math>,
compute the prediction information based on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>i</mi></msub><annotation encoding="application/x-tex">x_i</annotation></semantics></math>
for prediction model
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mi>i</mi></msub><annotation encoding="application/x-tex">F_i</annotation></semantics></math>,
and compute the required scores
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>F</mi><mi>i</mi></msub><mo>,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S(F_i,y_i)</annotation></semantics></math>.</p>
<p>The output should be a <code>data.frame</code> with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
rows that extends the original data frame with four additional columns
<code>mean</code>, <code>sd</code>, <code>se</code> and <code>ds</code>
of leave-one-out prediction means, standard deviations, and prediction
scores for the Squared Error and Dawid-Sebastiani scores.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">leave1out</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="cn">NA_real_</span>, sd <span class="op">=</span> <span class="cn">NA_real_</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filament1_estimate.html">filament1_estimate</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">i</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">model</span><span class="op">)</span></span>
<span>    <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filament1_predict.html">filament1_predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">i</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="st">"mean"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred</span><span class="op">$</span><span class="va">mean</span></span>
<span>    <span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="st">"sd"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred</span><span class="op">$</span><span class="va">sd</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      se <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"se"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>,</span>
<span>      ds <span class="op">=</span> <span class="fu"><a href="../reference/proper_score.html">proper_score</a></span><span class="op">(</span><span class="st">"ds"</span>, <span class="va">Actual_Weight</span>, mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr>
<p>The following code should work if your code is correct:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">score_A</span> <span class="op">&lt;-</span> <span class="fu">leave1out</span><span class="op">(</span><span class="va">filament1</span>, model <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span>
<span><span class="va">score_B</span> <span class="op">&lt;-</span> <span class="fu">leave1out</span><span class="op">(</span><span class="va">filament1</span>, model <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">CAD_Weight</span>, <span class="va">se</span>, colour <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">score_A</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">CAD_Weight</span>, <span class="va">se</span>, colour <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">score_B</span><span class="op">)</span></span></code></pre></div>
<p><img src="Tutorial09Solutions_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">CAD_Weight</span>, <span class="va">ds</span>, colour <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">score_A</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">CAD_Weight</span>, <span class="va">ds</span>, colour <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">score_B</span><span class="op">)</span></span></code></pre></div>
<p><img src="Tutorial09Solutions_files/figure-html/unnamed-chunk-5-2.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="exchangeability-test">Exchangeability test<a class="anchor" aria-label="anchor" href="#exchangeability-test"></a>
</h3>
<p>We want to investigate whether one model is better at predicting than
the other. If they are equivalent, it should not matter, on average, if
we randomly swap the A and B prediction scores within each leave-one-out
score pair
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>S</mi><mi>i</mi><mi>A</mi></msubsup><mo>,</mo><msubsup><mi>S</mi><mi>i</mi><mi>B</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(S^A_i, S^B_i)</annotation></semantics></math>.
Use the test statistic
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mi>N</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>S</mi><mi>i</mi><mi>A</mi></msubsup><mo>−</mo><msubsup><mi>S</mi><mi>i</mi><mi>B</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{1}{N}\sum_{i=1}^N (S^A_i - S^B_i)</annotation></semantics></math>,
and make a Monte Carlo estimate of the p-value for a test of
exchangeability between model predictions from A and from B against the
alternative hypothesis that B is better than A. First compute the test
statistic for the two prediction scores.</p>
<p>Hints: For this particular test statistic, one possible approach is
to first compute the pairwise score differences and then generate
randomisation samples by sampling random sign changes. Compute the test
statistic for each randomly altered set of values and compare with the
original test statistic. See the lecture on exchangeability for more
information. Start with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>=</mo><mn>1000</mn></mrow><annotation encoding="application/x-tex">J=1000</annotation></semantics></math>
iterations when testing your code. Increase to 10000 for more precise
results.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">score_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>se <span class="op">=</span> <span class="va">score_A</span><span class="op">$</span><span class="va">se</span> <span class="op">-</span> <span class="va">score_B</span><span class="op">$</span><span class="va">se</span>,</span>
<span>                         ds <span class="op">=</span> <span class="va">score_A</span><span class="op">$</span><span class="va">ds</span> <span class="op">-</span> <span class="va">score_B</span><span class="op">$</span><span class="va">ds</span><span class="op">)</span></span>
<span><span class="va">statistic0</span> <span class="op">&lt;-</span> <span class="va">score_diff</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span>, ds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ds</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span><span class="va">statistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span>,</span>
<span>                        ds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">loop</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">random_sign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">score_diff</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">statistic</span><span class="op">[</span><span class="va">loop</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">score_diff</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">random_sign</span> <span class="op">*</span> <span class="va">se</span><span class="op">)</span>,</span>
<span>                                                ds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">random_sign</span> <span class="op">*</span> <span class="va">ds</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">p_values</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">statistic</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">se</span> <span class="op">&gt;</span> <span class="va">statistic0</span><span class="op">$</span><span class="va">se</span><span class="op">)</span>,</span>
<span>            ds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ds</span> <span class="op">&gt;</span> <span class="va">statistic0</span><span class="op">$</span><span class="va">ds</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Estimates:</span></span>
<span><span class="va">p_values</span></span></code></pre></div>
<pre><code><span><span class="co">##       se     ds</span></span>
<span><span class="co">## 1 0.5011 0.0442</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Monte Carlo std.error::</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">p_values</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p_values</span><span class="op">)</span> <span class="op">/</span> <span class="va">J</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            se          ds</span></span>
<span><span class="co">## 1 0.004999988 0.002055392</span></span></code></pre>
<p>We see that for the Square Error scores, the two model predictions
appear exchangeable, but when prediction uncertainty is taken into
account in the Dawid-Sebastiani score, B appears to be better than A, on
average.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="pareto-smoothed-importance-sampling">Pareto smoothed importance sampling<a class="anchor" aria-label="anchor" href="#pareto-smoothed-importance-sampling"></a>
</h2>
<p>Explore the Pareto smoothed importance sampling (PSIS) method. Use a
t-distribution with 10 degrees of freedom, and importance sampling
distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∼</mo><mrow><mi>𝖭</mi><mi>𝗈</mi><mi>𝗋</mi><mi>𝗆</mi><mi>𝖺</mi><mi>𝗅</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">x\sim \mathsf{Normal}(0, \sigma^2)</annotation></semantics></math>
for different values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>.
Use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">N=100</annotation></semantics></math>
or more samples.</p>
<p>Use the <code><a href="https://mc-stan.org/loo/reference/psis.html" class="external-link">loo::psis()</a></code> function to compute Pareto smoothed
importance log-weights and diagnostics. What effect does different
values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
have on the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
parameter estimate? (the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>k</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{k}</annotation></semantics></math>
value is in the <code>$diagnostics$pareto_k</code> field of the
<code><a href="https://mc-stan.org/loo/reference/psis.html" class="external-link">loo::psis()</a></code> output.) Plot the original and smoothed
log-weights as a function of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>,
and with <code>stat_ecdf</code>, for different values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>,
including
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sigma=1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\sigma=2</annotation></semantics></math>.</p>
<hr>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span></span>
<span><span class="va">log_ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">dt</a></span><span class="op">(</span><span class="va">x</span>, df <span class="op">=</span> <span class="fl">10</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>, sd <span class="op">=</span> <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/psis.html" class="external-link">psis</a></span><span class="op">(</span><span class="va">log_ratio</span>, r_eff <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">pareto_k</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.692393</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">n_eff</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 98.14698</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>,</span>
<span>                 log_ratio <span class="op">=</span> <span class="va">log_ratio</span>,</span>
<span>                 log_weight <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">log_weights</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">log_ratio</span>, color <span class="op">=</span> <span class="st">"Original"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">log_weight</span>, color <span class="op">=</span> <span class="st">"Smoothed"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Tutorial09Solutions_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ecdf.html" class="external-link">stat_ecdf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">log_ratio</span>, color <span class="op">=</span> <span class="st">"Original"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ecdf.html" class="external-link">stat_ecdf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">log_weight</span>, color <span class="op">=</span> <span class="st">"Smoothed"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Tutorial09Solutions_files/figure-html/unnamed-chunk-7-2.png" width="576"></p>
<hr>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Finn Lindgren.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
