<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Statistical Computing: Lab tutorial 7">
<title>Tutorial 07: Data wrangling and cross validation • StatCompLab</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial 07: Data wrangling and cross validation">
<meta property="og:description" content="Statistical Computing: Lab tutorial 7">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">StatCompLab</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">21.9.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Project01.html">StatComp Project 1 (2021/22): Simulation and sampling</a>
    <a class="dropdown-item" href="../articles/Project01Hints.html">Project 01 Hints</a>
    <a class="dropdown-item" href="../articles/Tutorial01.html">Tutorial 01: R and linear models</a>
    <a class="dropdown-item" href="../articles/Tutorial01Solutions.html">Tutorial 01: R and linear models (solutions)</a>
    <a class="dropdown-item" href="../articles/Tutorial02.html">Tutorial 02: Optimization</a>
    <a class="dropdown-item" href="../articles/Tutorial02Solutions.html">Tutorial 02: Optimization (solutions)</a>
    <a class="dropdown-item" href="../articles/Tutorial03.html">Tutorial 03: Monte Carlo integration</a>
    <a class="dropdown-item" href="../articles/Tutorial03Solutions.html">Tutorial 03: Monte Carlo integration (solutions)</a>
    <a class="dropdown-item" href="../articles/Tutorial04.html">Tutorial 04: Uncertainty and integration</a>
    <a class="dropdown-item" href="../articles/Tutorial04Solutions.html">Tutorial 04: Uncertainty and integration (solutions)</a>
    <a class="dropdown-item" href="../articles/Tutorial06.html">Tutorial 06: Prediction assessment with proper scores</a>
    <a class="dropdown-item" href="../articles/Tutorial06Solutions.html">Tutorial 06: Prediction assessment with proper scores (solutions)</a>
    <a class="dropdown-item" href="../articles/Tutorial07.html">Tutorial 07: Data wrangling and cross validation</a>
    <a class="dropdown-item" href="../articles/Tutorial07Solutions.html">Tutorial 07: Data wrangling and cross validation (solutions)</a>
    <a class="dropdown-item" href="../articles/Tutorial08.html">Tutorial 08: Floating point computations and least squares</a>
    <a class="dropdown-item" href="../articles/Tutorial08Solutions.html">Tutorial 08: Floating point computations and least squares (solutions)</a>
    <a class="dropdown-item" href="../articles/Tutorial09.html">Tutorial 09: Bootstrap and Pareto smoothed importance sampling</a>
    <a class="dropdown-item" href="../articles/Tutorial09Solutions.html">Tutorial 09: Bootstrap and Pareto smoothed importance sampling (solutions)</a>
    <a class="dropdown-item" href="../articles/Project_Example.html">StatComp Project Example: Numerical statistics</a>
    <a class="dropdown-item" href="../articles/Project_Example_Solution.html">StatComp Project Example Solution: Numerical Statistics</a>
    <a class="dropdown-item" href="../articles/Quiz1Solution.html">Quiz 1 Solution (StatComp 2021/22)</a>
    <a class="dropdown-item" href="../articles/T4sol.html">Tutorial 04: Uncertainty and integration (full solution)</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/finnlindgren/StatCompLab/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Tutorial 07: Data wrangling and cross validation</h1>
                        <h4 data-toc-skip class="author">Finn Lindgren</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/finnlindgren/StatCompLab/blob/HEAD/vignettes/Tutorial07.Rmd" class="external-link"><code>vignettes/Tutorial07.Rmd</code></a></small>
      <div class="d-none name"><code>Tutorial07.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this lab session you will explore</p>
<ul>
<li>Data wrangling; restructuring data frames</li>
<li>Graphical data exploration</li>
<li>Cross validation</li>
</ul>
<ol style="list-style-type: decimal">
<li>Open your github repository clone project from Lab 2 or 4</li>
<li>During this lab, you can work in a <code>.R</code> file, but working with code chunks in a <code>.Rmd</code> is recommended.</li>
<li>Make sure you update the <code>StatCompLab</code> package to version 21.7.0 or higher.</li>
</ol>
<hr>
<p><strong>Solution:</strong></p>
<p>The accompanying <code>Tutorial07Solutions</code> tutorial/vignette documents contain the solutions explicitly, to make it easier to review the material after the workshops.</p>
<hr>
<p>Throughout this tutorial, you’ll make use of the data wrangling and plotting tools in the <code>dplyr</code>, <code>magrittr</code>, <code>ggplot2</code> and other tidyverse packages, so start your code with <code><a href="https://tidyverse.tidyverse.org" class="external-link">library(tidyverse)</a></code> and <code><a href="https://finnlindgren.github.io/StatCompLab">library(StatCompLab)</a></code>.</p>
<p>Note that the exercises in this tutorial build on each other, often with one solution being similar to previous solutions, with just a few additions and/or modifications.</p>
<p>Some of the data wrangling functions used in the tutorial are</p>
<ul>
<li>
<code>mutate</code> to add or alter variables</li>
<li>
<code>filter</code> to keep only rows fulfilling given criteria</li>
<li>
<code>group_by</code> to perform analyses within subgroups defined by one or more variables</li>
<li>
<code>summarise</code> to compute data summaries, usually with subgroups</li>
<li>
<code>select</code> to keep only some variables</li>
<li>
<code>left_join</code> to join two data frames together, based on common identifier variables</li>
<li>
<code>pivot_wider</code> to split a value variable into new named variables based on a category variable</li>
<li>
<code>pivot_longer</code> to gather several variables into a new single value variable, and the names stored in a new category variable</li>
<li>
<code>%&gt;%</code>, the “pipe” operator used to glue a sequence of operations together by feeding the result of an operation into the first argument of the following function call</li>
<li>
<code>head</code> to view only the first few rows of a data frame. This can be useful when debugging a sequence of “piped” expressions, by placing it last in the pipe sequence</li>
<li>
<code>pull</code> to extract the contents of a single variable</li>
</ul>
<p>Functions for plotting,</p>
<ul>
<li>
<code>ggplot</code> for initialising plots</li>
<li>
<code>geom_point</code> for drawing points</li>
<li>
<code>facet_wrap</code> for splitting a plot into “facet” plots, based on one or more category variables</li>
</ul>
</div>
<div class="section level2">
<h2 id="scottish-weather-data">Scottish weather data<a class="anchor" aria-label="anchor" href="#scottish-weather-data"></a>
</h2>
<p>The Global Historical Climatology Network at <a href="https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily" class="external-link uri">https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily</a> provides historical weather data collected from all over the globe. A subset of the daily resolution data set is available in the <code>StatCompLab package</code> containing data from eight weather stations in Scotland, covering the time period from 1 January 1960 to 31 December 2018. Some of the measurements are missing, either due to instrument problems or data collection issues. Load the data with</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ghcnd_stations</span>, package <span class="op">=</span> <span class="st">"StatCompLab"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ghcnd_values</span>, package <span class="op">=</span> <span class="st">"StatCompLab"</span><span class="op">)</span></code></pre></div>
<p>The <code>ghcnd_stations</code> data frame has 5 variables:</p>
<ul>
<li>
<code>ID</code>: The identifier code for each station</li>
<li>
<code>Name</code>: The humanly readable station name</li>
<li>
<code>Latitude</code>: The latitude of the station location, in degrees</li>
<li>
<code>Longitude</code>: The longitude of the station location, in degrees</li>
<li>
<code>Elevation</code>: The station elevation, in metres above sea level</li>
</ul>
<p>The station data set is small enough that you can view the whole thing, e.g. with <code>knitr::kable(ghcnd_stations)</code>. You can try to find some of the locations on a map (google maps an other online map systems can usually interpret latitude and longitude searches).</p>
<!--


-->
<p>The <code>ghcnd_values</code> data frame has 7 variables:</p>
<ul>
<li>
<code>ID</code>: The station identifier code for each observation</li>
<li>
<code>Year</code>: The year the value was measured</li>
<li>
<code>Month</code>: The month the value was measured</li>
<li>
<code>Day</code>: The day of the month the value was measured</li>
<li>
<code>DecYear</code>: “Decimal year”, the measurement date converted to a fractional value, where whole numbers correspond to 1 January, and fractional values correspond to later dates within the year. This is useful for both plotting and modelling.</li>
<li>
<code>Element</code>: One of “TMIN” (minimum temperature), “TMAX” (maximum temperature), or “PRCP” (precipitation), indicating what each value in the <code>Value</code> variable represents</li>
<li>
<code>Value</code>: Daily measured temperature (in degrees Celsius) or precipitation (in mm)</li>
</ul>
<p>The values data object has 502901 rows, so we don’t want to try to view the whole object directly. Instead, we can start by summarising it.</p>
<p>Start by counting how many observations each station has, for each type of measurement. The shortest approach is to use the <code><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count()</a></code> function. A more generalisable approach is to use the <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise()</a></code>, and n() functions. See the description on <code><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">?count</a></code> for how <code><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count()</a></code> is connected to the others. To avoid having to create temporary named variables, end the pipe operations with a call to <code><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">knitr::kable()</a></code>, especially if you’re working in an RMarkdown document.</p>
<!--


-->
</div>
<div class="section level2">
<h2 id="exploratory-plotting">Exploratory plotting<a class="anchor" aria-label="anchor" href="#exploratory-plotting"></a>
</h2>
<p>Before, we only looked at the station data and weather measurements separately. When plotting, we would at least like to have access to the station <em>names</em> instead of the <em>identifying codes</em>, to give a more humanly readable presentation.</p>
<p>This can be accomplished with the <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join()</a></code> function, that can add copies of the rows from one data frame to another, where one or more columns match. Create a new variable, <code>ghcnd</code> that for each observation contains both the measurements and the station data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ghcnd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ghcnd_values</span>, <span class="va">ghcnd_stations</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ghcnd</span><span class="op">)</span></code></pre></div>
<p>Now plot daily minimum and maximum temperature measurements connected by lines as a function of time (<code>DecYear</code>), with a different colour for each element, and a separate subplot for each station (<code>facet_wrap(~variablename)</code>), labeled by the station names.</p>
<p>Again, avoid creating a temporary named variable. Instead, feed the initial data wrangling result into <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code> directly.</p>
<!--


-->
<p>Due to the amount of data, it’s difficult to see clear patterns here. Produce two figures, one showing the yearly averages of TMIN and TMAX as points, and one showing the monthly seasonal averages (for months 1 through 12) of TMIN and TMAX, separately for each station.</p>
<p>Again, avoid creating a temporary named variable. In the previous code, insert calls to <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise()</a></code>, and modify the x-values in the aesthetics.</p>
<p>What are the common patterns in the yearly values, and in the monthly seasonal values?</p>
<!--

The yearly averages all seem to have a slight increasing trend:


The monthly seasonal averages clearly show the seasonal pattern. The shapes are similar for all stations, but the average and amplitude varies a bit:

-->
<div class="section level3">
<h3 id="scatter-plots">Scatter plots<a class="anchor" aria-label="anchor" href="#scatter-plots"></a>
</h3>
<p>If we want to do a scatter plot of TMIN and TMAX, we need to rearrange the data a bit. For this we can use the <code>pivot_wider</code> function, that can turn a <em>name</em> variable and a <em>values</em> variable into several named variable. Note that if only some measurement elements are present on a given day, NA’s will be produced by default. Optionally, filter these rows out before calling <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code>.</p>
<p>Draw a scatterplot for daily TMIN vs TMAX for each station, with colour determined by the month.</p>
<!--


-->
</div>
</div>
<div class="section level2">
<h2 id="cross-validation">Cross validation<a class="anchor" aria-label="anchor" href="#cross-validation"></a>
</h2>
<p>Choose one of the stations, and create a new data variable <code>data</code> from <code>ghcnd</code> with the yearly averages of TMIN as a column (as in the previous <code>pivot_wider</code> output), with missing values removed with <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code>.</p>
<!--


-->
<div class="section level3">
<h3 id="within-sample-assessment">Within-sample assessment<a class="anchor" aria-label="anchor" href="#within-sample-assessment"></a>
</h3>
<p>Now, using the whole <code>data</code> estimate a linear model for TMIN, with <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> formula <code>TMIN ~ 1 + Year</code>, and compute the average 80% Interval score (use <code><a href="../reference/proper_score.html">proper_score()</a></code> that you used in lab 6) for prediction intervals for each of the TMIN observations in <code>data</code>. See <code><a href="https://rdrr.io/r/stats/predict.lm.html" class="external-link">?predict.lm</a></code> for documentation for the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method for models estimated with <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>.</p>
<!--


-->
</div>
<div class="section level3">
<h3 id="cross-validation-1">Cross validation<a class="anchor" aria-label="anchor" href="#cross-validation-1"></a>
</h3>
<p>We now want to compute the 5 average 80% Interval scores from 5-fold cross validation based on a random partition of the data into 5 approximately equal parts.</p>
<p>First add a new column Group to data defining the partitioning, using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code>. One approach is to compute a random permutation index vector, and then use the modulus operator <code>%%</code> to reduce it to 5 values, or <code><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling()</a></code> on scaled indices.</p>
<!--


-->
<p>Then loop over the partition groups, estimating the model leaving the group out, and then predicting and scoring predictions for the group.</p>
<p>Compare the resulting scores with the one based on the whole data set. Is the average cross validation score larger or smaller?</p>
<!--



The average cross validation score for this problem is usually larger than the one
for the whole data set; it's is intended to reduce the risk of underestimating the
prediction error, so this is what we would expect. Repeat the random group allocation
to see how much it influences the cross validation score average.

-->
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Finn Lindgren.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
