<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StatComp Project 1 (2021/22): Simulation and sampling • StatCompLab</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="StatComp Project 1 (2021/22): Simulation and sampling">
<meta property="og:description" content="Statistical Computing (2021/22): Coursework project 1">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">StatCompLab</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">21.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Project01.html">StatComp Project 1 (2021/22): Simulation and sampling</a>
    </li>
    <li>
      <a href="../articles/Project01Hints.html">Project 01 Hints</a>
    </li>
    <li>
      <a href="../articles/Tutorial01.html">Tutorial 01: R and linear models</a>
    </li>
    <li>
      <a href="../articles/Tutorial01Solutions.html">Tutorial 01: R and linear models (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial02.html">Tutorial 02: Optimization</a>
    </li>
    <li>
      <a href="../articles/Tutorial02Solutions.html">Tutorial 02: Optimization (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial03.html">Tutorial 03: Monte Carlo integration</a>
    </li>
    <li>
      <a href="../articles/Tutorial03Solutions.html">Tutorial 03: Monte Carlo integration (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial04.html">Tutorial 04: Uncertainty and integration</a>
    </li>
    <li>
      <a href="../articles/Tutorial04Solutions.html">Tutorial 04: Uncertainty and integration (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial06.html">Tutorial 06: Prediction assessment with proper scores</a>
    </li>
    <li>
      <a href="../articles/Tutorial06Solutions.html">Tutorial 06: Prediction assessment with proper scores (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial07.html">Tutorial 07: Data wrangling and cross validation</a>
    </li>
    <li>
      <a href="../articles/Tutorial07Solutions.html">Tutorial 07: Data wrangling and cross validation (solutions)</a>
    </li>
    <li>
      <a href="../articles/Tutorial08.html">Tutorial 08: Floating point computations and least squares</a>
    </li>
    <li>
      <a href="../articles/Tutorial08Solutions.html">Tutorial 08: Floating point computations and least squares (solutions)</a>
    </li>
    <li>
      <a href="../articles/Project_Example.html">StatComp Project Example: Numerical statistics</a>
    </li>
    <li>
      <a href="../articles/Project_Example_Solution.html">StatComp Project Example Solution: Numerical Statistics</a>
    </li>
    <li>
      <a href="../articles/Quiz1Solution.html">Quiz 1 Solution (StatComp 2021/22)</a>
    </li>
    <li>
      <a href="../articles/T4sol.html">Tutorial 04: Uncertainty and integration (full solution)</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/finnlindgren/StatCompLab/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Project01_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>StatComp Project 1 (2021/22): Simulation and sampling</h1>
                        <h4 data-toc-skip class="author">Finn Lindgren</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/finnlindgren/StatCompLab/blob/HEAD/vignettes/Project01.Rmd" class="external-link"><code>vignettes/Project01.Rmd</code></a></small>
      <div class="hidden name"><code>Project01.Rmd</code></div>

    </div>

    
    
<p>This document can either be accessed in html form on <a href="https://finnlindgren.github.io/StatCompLab/">https://finnlindgren.github.io/StatCompLab/</a>, as a vignette in <code>StatCompLab</code> version 21.5.0 or later, with <code><a href="../articles/Project01.html">vignette("Project01", "StatCompLab")</a></code>, or in pdf format on Learn.</p>
<ol style="list-style-type: decimal">
<li>You have been assigned a <code>project01-username</code> repository on <a href="https://github.com/StatComp21/" class="external-link">https://github.com/StatComp21/</a>. Use <code>git</code> to <em>clone</em> the repository (either to <a href="https://rstudio.cloud" class="external-link">https://rstudio.cloud</a> or your own computer) in the same way as the <code>lab*-username</code> repositories for tutorials 2 and 4.</li>
<li>The repository contains a template RMarkdown document, <code>report.Rmd</code>, that you should expand with your answers and solutions for this project assignment, and a code files for function definitions, <code>code.R</code>, that contains some predefined functions, and you should add your own function definitions and function documentation to that file. Do not change these filenames.</li>
<li>The function definitions should be included in the <code>report.Rmd</code> file in exactly the way already shown in the document. This will make the function defintions available throughout the document, but only shown in the code appendix.</li>
<li>The main text should be a coherent presentation of theory and discussion of methods and results, showing code for code chunks that perform computations and analysis, but not code for code chunks that generate figures or tables. Use the <code>echo=TRUE</code> and <code>echo=FALSE</code> to control what code is visible.</li>
<li>The <code>styler</code> package Addin for restyling code for better and consistent readability works for both <code>.R</code> and <code>.Rmd</code> files.</li>
<li>The <code>Project01Hints</code> vignette contains some useful tips.</li>
</ol>
<p>The assignment is submitted by pushing your work to the github repository before your submission deadline. Make sure you include your name, student number, and github username in both <code>report.Rmd</code> and <code>code.R</code>. When submitting, also include a generated html version of the report, with filename <code>report.html</code>. Normally, generated images are automatically included in the html file itself; otherwise they need to be added to the repository as well.</p>
<p>It is strongly recommended to commit and push to github frequently. If you’re uncertain about whether you’re pushing all the needed submission files to github, ask Finn to check the repository contents <em>at least</em> a week before the submission deadline.</p>
<p>The submission deadline is Monday 7 March 2022, at 16:00 (Edinburgh time). See the Assessment page on Learn for extensions and late submission penalty details.</p>
<p>The project will be marked as a whole, with marks between <span class="math inline">\(0\)</span> and <span class="math inline">\(40\)</span>. A marking guide will be posted on Learn.</p>
<div style="page-break-after: always;"></div>
<div class="section level2">
<h2 id="confidence-interval-approximation-assessment">Confidence interval approximation assessment<a class="anchor" aria-label="anchor" href="#confidence-interval-approximation-assessment"></a>
</h2>
<p>As in Lab 4, consider the Poisson model for observations <span class="math inline">\(\boldsymbol{y}=\{y_1,\dots,y_n\}\)</span>: <span class="math display">\[
\begin{aligned}
y_i &amp; \sim \mathsf{Poisson}(\lambda), \quad\text{independent for $i=1,\dots,n$.}
\end{aligned}
\]</span> that has joint probability mass function <span class="math display">\[
p(\boldsymbol{y}|\lambda) = \exp(-n\lambda) \prod_{i=1}^n \frac{\lambda^{y_i}}{y_i!}
\]</span> In the lab, one of the considered parameterisation alternatives was</p>
<ol style="list-style-type: decimal">
<li>
<span class="math inline">\(\theta = \lambda\)</span>, and <span class="math inline">\(\widehat{\theta}_\text{ML}=\frac{1}{n}\sum_{i=1}^n y_i = \overline{y}\)</span>
</li>
</ol>
<p>The confidence interval construction was motivated by the ratio <span class="math inline">\(\frac{\widehat{\lambda}-\lambda}{\sqrt{\lambda/n}}\)</span>, which was approximated by <span class="math inline">\(\frac{\widehat{\lambda}-\lambda}{\sqrt{\widehat{\lambda}/n}}\)</span>. We now wish to see if we would achieve a better construction by using the non-approximated version.</p>
<p>Solve the inequalities in <span class="math display">\[
a = z_{\alpha/2} &lt; \frac{\widehat{\lambda}-\lambda}{\sqrt{\lambda/n}} &lt; z_{1-\alpha/2} = b
\]</span> with respect to <span class="math inline">\(\lambda\)</span>, and implement the resulting confidence interval construction in a function (in <code>code.R</code>; also document the function) taking arguments <code>y</code> and <code>alpha</code>. Also include another function for the method used in the lab, with the same call syntax.</p>
<p>Hint: It may help to do the mathematical derivation in several steps; e.g. by introducing <span class="math inline">\(x=\sqrt{\lambda}\)</span>, solve two separate quadratic equations (on with <span class="math inline">\(a\)</span> and one with <span class="math inline">\(b\)</span>) and then work out for what intervals the two inequalities are fulfilled. For that, you likely will need the fact that for <span class="math inline">\(\alpha&lt;0.5\)</span>, we have <span class="math inline">\(z_{\alpha/2}&lt;0\)</span> and <span class="math inline">\(\z_{1-\alpha/2}&gt;0\)</span>.</p>
<p>The function <code>estimate_coverage</code>, defined in <code>code.R</code>, can be used to estimate the coverage of the construction of confidence intervals from samples <span class="math inline">\(\mathsf{Poisson}(\lambda)\)</span>, given an interval construction R function. Use this to discuss the following questions:</p>
<p>Which of the two alternatives has coverage closest to the nominal coverage of 90% for the case <span class="math inline">\(n=2\)</span>, <span class="math inline">\(\lambda=3\)</span>? What happens for larger values of <span class="math inline">\(n\)</span>?</p>
<div style="page-break-after: always;"></div>
</div>
<div class="section level2">
<h2 id="d-printer-materials-prediction">3D printer materials prediction<a class="anchor" aria-label="anchor" href="#d-printer-materials-prediction"></a>
</h2>
<p>The aim is estimate the parameters of a Bayesian statistical model of material use in a 3D printer.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> The printer uses rolls of <em>filament</em> that gets heated and squeezed through a moving nozzle, gradually building objects. The objects are first designed in a CAD program (Computer Aided Design), that also estimates how much material will be required to print the object.</p>
<p>The data can be loaded with <code>data("filament1", package = "StatCompLab")</code>, and contains information about one 3D-printed object per row. The columns are</p>
<ul>
<li>
<code>Index</code>: an observation index</li>
<li>
<code>Date</code>: printing dates</li>
<li>
<code>Material</code>: the printing material, identified by its colour</li>
<li>
<code>CAD_Weight</code>: the object weight (in gram) that the CAD software calculated</li>
<li>
<code>Actual_Weight</code>: the actual weight of the object (in gram) after printing</li>
</ul>
<p>If the CAD system and printer were both perfect, the <code>CAD_Weight</code> and <code>Actual_Weight</code> values would be equal for each object. In reality, there is both random variation, for example due to varying humidity and temperature, and systematic deviations due to the CAD system not having perfect information about the properties of the printing materials.</p>
<p>When looking at the data (see below) it’s clear that the variability of the data is larger for larger values of <code>CAD_Weight</code>. The printer operator has made a simple physics analysis, and settled on a model where the connection between <code>CAD_Weight</code> and <code>Actual_Weight</code> follows a linear model, and the variance increases with square of <code>CAD_Weight</code>. If we denote the CAD weight for observations <span class="math inline">\(i\)</span> by <code>x_i</code>, and the corresponding actual weight by <span class="math inline">\(y_i\)</span>, the model can be defined by</p>
<p><span class="math display">\[
y_i \sim \mathsf{Normal}[\beta_1 + \beta_2 x_i, \beta_3 + \beta_4 x_i^2)] .
\]</span> To ensure positivity of the variance, the parameterisation <span class="math inline">\(\boldsymbol{\theta}=[\theta_1,\theta_2,\theta_3,\theta_4]=[\beta_1,\beta_2,\log(\beta_3),\log(\beta_4)]\)</span> is introduced, and the printer operator assigns independent prior distributions as follows: <span class="math display">\[
\begin{aligned}
\theta_1 &amp;\sim \mathsf{Normal}(0,\gamma_1), \\
\theta_2 &amp;\sim \mathsf{Normal}(1,\gamma_2), \\
\theta_3 &amp;\sim \mathsf{LogExp}(\gamma_3), \\
\theta_4 &amp;\sim \mathsf{LogExp}(\gamma_4),
\end{aligned}
\]</span> where <span class="math inline">\(\mathsf{LogExp}(a)\)</span> denotes the logarithm of an exponentially distributed random variable with rate parameter <span class="math inline">\(a\)</span>, as seen in Tutorial 4. The <span class="math inline">\(\boldsymbol{\gamma}=(\gamma_1,\gamma_2,\gamma_3,\gamma_4)\)</span> values are positive parameters.</p>
<p>The printer operator reasons that due to random fluctuations in the material properties (such as the density) and room temperature should lead to a <em>relative</em> error instead of an additive error, and this is what lead them to the model, as an approximation of that. The basic physics assumption is that the error in the CAD software calculation of the weight is proportional to the weight itself.</p>
<p>Start by loading the data and plot it.</p>
<div class="section level3">
<h3 id="prior-density">Prior density<a class="anchor" aria-label="anchor" href="#prior-density"></a>
</h3>
<p>With the help of <code>dnorm</code> and the <code>dlogexp</code> function (see the <code>code.R</code> file for documentation), define and document (in <code>code.R</code>) a function <code>log_prior_density</code> with arguments <code>theta</code> and <code>params</code>, where theta is the <span class="math inline">\(\boldsymbol{\theta}\)</span> parameter vector, and <code>params</code> is the vector of <span class="math inline">\(\boldsymbol{\gamma}\)</span> parameters. Your function should evaluate the logarithm of the joint prior density <span class="math inline">\(p(\boldsymbol{\theta})\)</span> for the four <span class="math inline">\(\theta_i\)</span> parameters.</p>
</div>
<div class="section level3">
<h3 id="observation-likelihood">Observation likelihood<a class="anchor" aria-label="anchor" href="#observation-likelihood"></a>
</h3>
<p>With the help of <code>dnorm</code>, define and document a function <code>log_like</code>, taking arguments <code>theta</code>, <code>x</code>, and <code>y</code>, that evaluates the observation log-likelihood <span class="math inline">\(p(\boldsymbol{y}|\boldsymbol{\theta})\)</span> for the model defined above.</p>
</div>
<div class="section level3">
<h3 id="posterior-density">Posterior density<a class="anchor" aria-label="anchor" href="#posterior-density"></a>
</h3>
<p>Define and document a function <code>log_posterior_density</code> with arguments <code>theta</code>, <code>x</code>, <code>y</code>, and <code>params</code>, that evaluates the logarithm of the posterior density <span class="math inline">\(p(\boldsymbol{\theta}|\boldsymbol{y})\)</span>, apart from some unevaluated normalisation constant.</p>
</div>
<div class="section level3">
<h3 id="posterior-mode-and-gaussian-approximation">Posterior mode and Gaussian approximation<a class="anchor" aria-label="anchor" href="#posterior-mode-and-gaussian-approximation"></a>
</h3>
<p>Let all <span class="math inline">\(\gamma_i=1\)</span>, <span class="math inline">\(i=1,2,3,4\)</span>, and use <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> together with the <code>log_posterior_density</code> and filament data to find the posterior mode for <span class="math inline">\(\boldsymbol{\theta}\)</span>. Also evaluate the inverse of the negated Hessian at the mode, in order to obtain a multivariate Normal approximation <span class="math inline">\(\mathsf{Normal}(\boldsymbol{\mu},\boldsymbol{S})\)</span> to the posterior distribution for <span class="math inline">\(\boldsymbol{\theta}\)</span>. See the documentation for <code>optim</code> for how to do maximisation instead of minimisation.</p>
</div>
<div class="section level3">
<h3 id="importance-sampling-function">Importance sampling function<a class="anchor" aria-label="anchor" href="#importance-sampling-function"></a>
</h3>
<p>The aim is to construct a 90% Bayesian credible interval for each <span class="math inline">\(\beta_j\)</span> using importance sampling, similarly to the method used in lab 4. There, a one dimensional Gaussian approximation of the posterior of a parameter was used. Here, we will instead use a multivariate Normal approximation as the importance sampling distribution. The functions <code>rmvnorm</code> and <code>dmvnorm</code> in the <code>mvtnorm</code> package can be used to sample and evaluate densities.</p>
<p>Define and document a function <code>do_importance</code> taking arguments <code>N</code> (the number of samples to generate), <code>mu</code> (the mean vector for the importance distribution), and <code>S</code> (the covariance matrix), and other additional parameters that are needed by the function code.</p>
<p>The function should output a <code>data.frame</code> with five columns, <code>beta1</code>, <code>beta2</code>, <code>beta3</code>, <code>beta4</code>, <code>log_weights</code>, containing the <span class="math inline">\(\beta_i\)</span> samples and normalised <span class="math inline">\(\log\)</span>-importance-weights, so that <code>sum(exp(log_weights))</code> is <span class="math inline">\(1\)</span>. Use the <code>log_sum_exp</code> function to compute the needed normalisation information.</p>
</div>
<div class="section level3">
<h3 id="importance-sampling">Importance sampling<a class="anchor" aria-label="anchor" href="#importance-sampling"></a>
</h3>
<p>Use your defined functions to compute an importance sample of size <span class="math inline">\(N=10000\)</span>. Plot the empirical weighted CDFs together with the un-weighted CDFs for each parameter, with the help of <code>stat_ewcdf</code>, and discuss the results. To achieve simpler <code>ggplot</code> code, you may find <code>pivot_longer(???, starts_with("beta"))</code> and <code>facet_wrap(vars(name))</code> useful.</p>
<p>Construct 90% credible intervals for each of the four model parameters, based on the importance sample. In addition to <code>wquantile</code> and <code>pivot_longer</code>, the methods <code>group_by</code> and <code>summarise</code> are helpful. You may wish to define a function <code>make_CI</code> taking arguments <code>x</code>, <code>weights</code>, and <code>prob</code> (to control the intended coverage probability), generating a 1-row, 2-column <code>data.frame</code> to help structure the code.</p>
<p>Discuss the results both from the sampling method point of view and the 3D printer application point of view (this may also involve e.g. plotting prediction intervals based on point estimates of the parameters, and plotting the importance log-weights to see how they depend on the sampled <span class="math inline">\(\beta\)</span>-values, like in the <code>T4sol</code> document).</p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Special thanks to Sten Lindgren for providing the printer data.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Finn Lindgren.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
